<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>PolyPilot</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="PolyPilot.styles.css" />
    <link rel="icon" href="data:,">
</head>

<body>

    <div id="app">Loading...</div>

    <div id="blazor-error-ui" data-nosnippet>
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>

    <script src="_framework/blazor.webview.js" autostart="false"></script>
    <script src="chobitsu.js"></script>
    <script>
        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Global keyboard listener â€” registered immediately on load
        document.addEventListener('keydown', function(e) {
            // Ctrl+] for next session, Ctrl+[ for previous
            if (e.ctrlKey && e.code === 'BracketRight' && window._tabDotNetRef) {
                e.preventDefault();
                window._tabDotNetRef.invokeMethodAsync('CycleSession', false);
            } else if (e.ctrlKey && e.code === 'BracketLeft' && window._tabDotNetRef) {
                e.preventDefault();
                window._tabDotNetRef.invokeMethodAsync('CycleSession', true);
            }
        }, true);

        // Global image paste handler for chat inputs
        document.addEventListener('paste', function(e) {
            var sel = '.card-input input, .card-input textarea, .input-row textarea';
            if (!e.target.matches || !e.target.matches(sel)) return;
            if (!window.__dashRef) return;
            var cd = e.clipboardData;
            if (!cd) return;

            // Try clipboardData.items first (works in most browsers)
            var items = cd.items;
            if (items) {
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.startsWith('image/')) {
                        e.preventDefault();
                        var file = items[i].getAsFile();
                        if (file) {
                            var reader = new FileReader();
                            reader.onload = function() {
                                var base64 = reader.result.split(',')[1];
                                var ext = (file.name && file.name.includes('.')) ? file.name.split('.').pop() : 'png';
                                var name = file.name || ('pasted-image.' + ext);
                                window.__dashRef.invokeMethodAsync('JsImagePasted', base64, name, ext, e.target.id || '');
                            };
                            reader.readAsDataURL(file);
                        }
                        return;
                    }
                }
            }

            // Fallback: check clipboardData.files (more reliable on Mac Catalyst WKWebView)
            var files = cd.files;
            if (files && files.length > 0) {
                for (var fi = 0; fi < files.length; fi++) {
                    if (files[fi].type.startsWith('image/')) {
                        e.preventDefault();
                        (function(f) {
                            var reader = new FileReader();
                            reader.onload = function() {
                                var base64 = reader.result.split(',')[1];
                                var ext = (f.name && f.name.includes('.')) ? f.name.split('.').pop() : 'png';
                                var name = f.name || ('pasted-image.' + ext);
                                window.__dashRef.invokeMethodAsync('JsImagePasted', base64, name, ext, e.target.id || '');
                            };
                            reader.readAsDataURL(f);
                        })(files[fi]);
                        return;
                    }
                }
            }
        }, true);

        // Global image drop handler for chat input areas
        document.addEventListener('dragover', function(e) {
            var zone = e.target.closest && (e.target.closest('.input-area') || e.target.closest('.card-input'));
            if (zone && e.dataTransfer && Array.from(e.dataTransfer.types).includes('Files')) {
                e.preventDefault();
                zone.classList.add('drag-over');
            }
        });
        document.addEventListener('dragleave', function(e) {
            var zone = e.target.closest && (e.target.closest('.input-area') || e.target.closest('.card-input'));
            if (zone) zone.classList.remove('drag-over');
        });
        document.addEventListener('drop', function(e) {
            var zone = e.target.closest && (e.target.closest('.input-area') || e.target.closest('.card-input'));
            if (!zone) return;
            e.preventDefault();
            zone.classList.remove('drag-over');
            var input = zone.querySelector('textarea') || zone.querySelector('input');
            var inputId = input ? input.id : '';
            var files = e.dataTransfer && e.dataTransfer.files;
            if (!files || !window.__dashRef) return;
            for (var i = 0; i < files.length; i++) {
                if (files[i].type.startsWith('image/')) {
                    (function(f) {
                        var reader = new FileReader();
                        reader.onload = function() {
                            var base64 = reader.result.split(',')[1];
                            var ext = (f.name && f.name.includes('.')) ? f.name.split('.').pop() : 'png';
                            var name = f.name || ('dropped-image.' + ext);
                            window.__dashRef.invokeMethodAsync('JsImagePasted', base64, name, ext, inputId);
                        };
                        reader.readAsDataURL(f);
                    })(files[i]);
                }
            }
        });

        window.setupTextareaEnterHandler = function(element) {
            if (!element || element._enterHandlerSet) return;
            element._enterHandlerSet = true;
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    // Reset height after send
                    setTimeout(function() { element.style.height = 'auto'; }, 50);
                    // Remove slash command ghost overlay
                    var ghost = document.getElementById(element.id + '--slash-ghost');
                    if (ghost) ghost.style.display = 'none';
                }
                // Tab / Shift+Tab to cycle sessions
                if (e.key === 'Tab' && window._tabDotNetRef) {
                    e.preventDefault();
                    e.stopPropagation();
                    window._tabDotNetRef.invokeMethodAsync('CycleSession', !e.shiftKey);
                }
            });
            element.addEventListener('input', function() {
                element.style.height = 'auto';
                element.style.height = Math.min(element.scrollHeight, 200) + 'px';
            });
        };

        // Auto-scroll overflowed text on hover

        window.scrollToBottom = function(element) {
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        };

        window.smartScrollToBottom = function(element) {
            if (!element) return;
            var threshold = 300;
            var distFromBottom = element.scrollHeight - element.scrollTop - element.clientHeight;
            var isNearBottom = distFromBottom < threshold;
            if (isNearBottom || element.__wasAtBottom) {
                requestAnimationFrame(function() {
                    element.scrollTop = element.scrollHeight;
                });
            }
        };

        window.isScrolledToBottom = function(element) {
            if (!element) return true;
            return (element.scrollHeight - element.scrollTop - element.clientHeight) < 300;
        };

        window.inspectMessages = function() {
            var msgs = document.querySelector('.messages');
            if (!msgs) return 'No .messages element';
            var children = msgs.children;
            var result = 'Container: w=' + msgs.clientWidth + ' h=' + msgs.clientHeight + ' scrollW=' + msgs.scrollWidth + ', display=' + getComputedStyle(msgs).display + ', flexDir=' + getComputedStyle(msgs).flexDirection + ', alignItems=' + getComputedStyle(msgs).alignItems + '\n';
            for (var i = 0; i < Math.min(children.length, 30); i++) {
                var c = children[i];
                var cs = getComputedStyle(c);
                result += i + ': <' + c.tagName + '> class="' + c.className.substring(0, 50) + '" w=' + c.clientWidth + '/' + c.offsetWidth + ' h=' + c.clientHeight + '/' + c.offsetHeight + ' display=' + cs.display + ' maxW=' + cs.maxWidth + ' width=' + cs.width + ' alignSelf=' + cs.alignSelf + ' overflow=' + cs.overflow + '\n';
            }
            var toolCards = document.querySelectorAll('.tool-card');
            if (toolCards.length > 0) {
                result += '\n=== TOOL CARDS ===\n';
                toolCards.forEach(function(tc, i) {
                    var tcs = getComputedStyle(tc);
                    var parent = tc.parentElement;
                    var ps = parent ? getComputedStyle(parent) : null;
                    result += 'TC' + i + ': w=' + tc.clientWidth + '/' + tc.offsetWidth + ' h=' + tc.clientHeight + '/' + tc.offsetHeight + ' display=' + tcs.display + ' width=' + tcs.width + ' minW=' + tcs.minWidth + ' overflow=' + tcs.overflow + '\n';
                    if (parent) result += '  parent: <' + parent.tagName + '> class="' + parent.className.substring(0, 40) + '" w=' + parent.clientWidth + ' display=' + ps.display + ' width=' + ps.width + '\n';
                });
            }
            return result;
        };

        window.setupTabNavigation = function(dotnetRef) {
            window._tabDotNetRef = dotnetRef;
        };

        window.showNotification = function(sessionName, summary) {
            // Play a sound
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEA...');
                // Simple beep instead
            } catch(e) {}

            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('PolyPilot: ' + sessionName, {
                    body: summary.substring(0, 100) + (summary.length > 100 ? '...' : ''),
                    icon: 'ðŸ¤–',
                    tag: 'session-complete-' + sessionName
                });
            }
            
            // Also show in-app notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = '<strong>' + window.escapeHtml(sessionName) + '</strong> finished<br/>' + 
                window.escapeHtml(summary.substring(0, 80)) + (summary.length > 80 ? '...' : '');
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        // Image drag-and-drop + paste support
        window.setupImageDropZone = function(dropZoneElement, dotNetRef) {
            if (!dropZoneElement || dropZoneElement._dropSetup) return;
            dropZoneElement._dropSetup = true;

            dropZoneElement.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZoneElement.classList.add('drag-over');
            });
            dropZoneElement.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZoneElement.classList.remove('drag-over');
            });
            dropZoneElement.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZoneElement.classList.remove('drag-over');
                var files = e.dataTransfer.files;
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.type.startsWith('image/')) {
                        readFileAsBase64(file, dotNetRef);
                    }
                }
            });

            // Paste support on the textarea inside
            var textarea = dropZoneElement.querySelector('textarea');
            if (textarea) {
                textarea.addEventListener('paste', function(e) {
                    var items = e.clipboardData && e.clipboardData.items;
                    if (!items) return;
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.startsWith('image/')) {
                            e.preventDefault();
                            var file = items[i].getAsFile();
                            if (file) readFileAsBase64(file, dotNetRef);
                            return;
                        }
                    }
                });
            }
        };

        function readFileAsBase64(file, dotNetRef) {
            var reader = new FileReader();
            reader.onload = function() {
                var base64 = reader.result.split(',')[1];
                var ext = file.name.split('.').pop() || 'png';
                dotNetRef.invokeMethodAsync('OnImageDropped', base64, file.name, ext);
            };
            reader.readAsDataURL(file);
        }

        window.triggerImageFilePicker = function(inputElement) {
            if (inputElement) inputElement.click();
        };

        window.readSelectedFiles = function(inputElement) {
            if (!inputElement || !inputElement.files) return null;
            var results = [];
            var promises = [];
            for (var i = 0; i < inputElement.files.length; i++) {
                var file = inputElement.files[i];
                if (!file.type.startsWith('image/')) continue;
                (function(f) {
                    var p = new Promise(function(resolve) {
                        var reader = new FileReader();
                        reader.onload = function() {
                            var base64 = reader.result.split(',')[1];
                            var ext = f.name.split('.').pop() || 'png';
                            results.push(base64, f.name, ext);
                            resolve();
                        };
                        reader.readAsDataURL(f);
                    });
                    promises.push(p);
                })(file);
            }
            return Promise.all(promises).then(function() {
                inputElement.value = '';
                return results;
            });
        };

        window.setAppFontSize = function(size) {
            document.documentElement.style.setProperty('--app-font-size', size + 'px');
        };

        // Safe DOM helpers â€” avoid eval() with interpolated strings
        window.getElementValue = function(elementId) {
            var el = document.getElementById(elementId);
            return el ? (el.value || '') : '';
        };

        window.clearElementValue = function(elementId) {
            var el = document.getElementById(elementId);
            if (el) {
                el.value = '';
                el.style.height = 'auto';
                // Remove slash command ghost overlay
                var ghost = document.getElementById(elementId + '--slash-ghost');
                if (ghost) ghost.style.display = 'none';
                // Hide slash command dropdown if targeting this element
                if (window._slashHideDropdown) window._slashHideDropdown(el);
            }
        };

        window.escapeHtml = function(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        };

        window.clickElement = function(elementId) {
            var el = document.getElementById(elementId);
            if (el) el.click();
        };

        window.ensureFiestaMentionAutocomplete = function() {
            if (window.__fiestaMentionSetup) return;
            window.__fiestaMentionSetup = true;

            var state = {
                dropdown: null,
                target: null,
                options: [],
                selectedIndex: 0,
                mentionStart: -1,
                mentionEnd: -1
            };

            function getWorkers(el) {
                var raw = (el && el.getAttribute && el.getAttribute('data-fiesta-workers')) || '';
                if (!raw) return [];
                var seen = {};
                return raw.split(',')
                    .map(function(v) { return (v || '').trim(); })
                    .filter(function(v) {
                        if (!v || /[^A-Za-z0-9._-]/.test(v)) return false;
                        var key = v.toLowerCase();
                        if (seen[key]) return false;
                        seen[key] = true;
                        return true;
                    });
            }

            function getMentionContext(el) {
                var text = el && typeof el.value === 'string' ? el.value : '';
                var cursor = (el && typeof el.selectionStart === 'number') ? el.selectionStart : text.length;
                var left = text.slice(0, cursor);
                var atIndex = left.lastIndexOf('@');
                if (atIndex < 0) return null;
                if (atIndex > 0 && /\S/.test(left.charAt(atIndex - 1))) return null;

                var fragment = left.slice(atIndex + 1);
                if (/[^A-Za-z0-9._-]/.test(fragment)) return null;

                return {
                    start: atIndex,
                    end: cursor,
                    query: fragment || ''
                };
            }

            function ensureDropdown() {
                if (state.dropdown) return state.dropdown;
                var d = document.createElement('div');
                d.id = 'fiesta-mention-autocomplete';
                d.style.cssText =
                    'position:fixed;z-index:10020;display:none;min-width:180px;max-width:300px;max-height:220px;overflow-y:auto;' +
                    'background:var(--bg-tertiary,#1e1e2e);border:1px solid var(--control-border,#45475a);border-radius:8px;' +
                    'box-shadow:0 8px 24px rgba(0,0,0,0.35);padding:4px;';
                document.body.appendChild(d);
                state.dropdown = d;
                return d;
            }

            function hideDropdown() {
                if (state.dropdown) state.dropdown.style.display = 'none';
                state.target = null;
                state.options = [];
                state.selectedIndex = 0;
                state.mentionStart = -1;
                state.mentionEnd = -1;
            }

            function updateDropdownPosition() {
                if (!state.dropdown || !state.target) return;
                var rect = state.target.getBoundingClientRect();
                var left = Math.max(8, Math.min(rect.left, window.innerWidth - 320));
                var spaceBelow = window.innerHeight - rect.bottom - 8;
                var spaceAbove = rect.top - 8;
                var openUp = spaceBelow < 120 && spaceAbove > spaceBelow;
                var maxHeight = Math.min(220, Math.max(120, openUp ? spaceAbove : spaceBelow));
                var contentHeight = state.dropdown.scrollHeight || state.dropdown.offsetHeight || 120;
                var visibleHeight = Math.min(maxHeight, contentHeight);
                var top = openUp
                    ? Math.max(8, rect.top - visibleHeight - 6)
                    : Math.min(rect.bottom + 6, window.innerHeight - visibleHeight - 8);
                state.dropdown.style.left = left + 'px';
                state.dropdown.style.top = top + 'px';
                state.dropdown.style.maxHeight = maxHeight + 'px';
            }

            function chooseOption(index) {
                if (!state.target || !state.options[index]) return;
                var target = state.target;
                var mention = '@' + state.options[index] + ' ';
                var value = target.value || '';
                var before = value.slice(0, state.mentionStart);
                var after = value.slice(state.mentionEnd);
                target.value = before + mention + after;
                var nextCursor = before.length + mention.length;
                target.focus();
                target.setSelectionRange(nextCursor, nextCursor);
                hideDropdown();
                target.dispatchEvent(new Event('input', { bubbles: true }));
            }

            function renderDropdown() {
                var dropdown = ensureDropdown();
                if (!state.target || state.options.length === 0) {
                    hideDropdown();
                    return;
                }

                dropdown.innerHTML = '';
                state.options.forEach(function(option, idx) {
                    var item = document.createElement('button');
                    item.type = 'button';
                    item.textContent = '@' + option;
                    item.style.cssText =
                        'display:block;width:100%;text-align:left;border:none;border-radius:6px;padding:6px 8px;' +
                        'font-size:12px;cursor:pointer;line-height:1.25;' +
                        (idx === state.selectedIndex
                            ? 'background:var(--hover-bg,#313244);color:var(--text-primary,#cdd6f4);'
                            : 'background:transparent;color:var(--text-secondary,#bac2de);');
                    item.addEventListener('mouseenter', function() {
                        state.selectedIndex = idx;
                        renderDropdown();
                    });
                    item.addEventListener('mousedown', function(ev) {
                        ev.preventDefault();
                        chooseOption(idx);
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
                updateDropdownPosition();
            }

            function refreshForTarget(el) {
                if (!el || !el.matches || !el.matches('textarea[data-fiesta-workers]')) {
                    hideDropdown();
                    return;
                }

                var workers = getWorkers(el);
                if (workers.length === 0) {
                    hideDropdown();
                    return;
                }

                var context = getMentionContext(el);
                if (!context) {
                    hideDropdown();
                    return;
                }

                var q = context.query.toLowerCase();
                var filtered = workers.filter(function(w) {
                    return w.toLowerCase().indexOf(q) === 0;
                }).slice(0, 12);

                if (filtered.length === 0) {
                    hideDropdown();
                    return;
                }

                state.target = el;
                state.options = filtered;
                state.mentionStart = context.start;
                state.mentionEnd = context.end;
                if (state.selectedIndex >= filtered.length) state.selectedIndex = 0;
                renderDropdown();
            }

            document.addEventListener('input', function(e) {
                if (e.target && e.target.matches && e.target.matches('textarea[data-fiesta-workers]'))
                    refreshForTarget(e.target);
            }, true);

            document.addEventListener('click', function(e) {
                if (state.dropdown && state.dropdown.contains(e.target)) return;
                if (e.target && e.target.matches && e.target.matches('textarea[data-fiesta-workers]')) {
                    refreshForTarget(e.target);
                    return;
                }
                hideDropdown();
            }, true);

            document.addEventListener('keydown', function(e) {
                if (!state.target || !state.dropdown || state.dropdown.style.display === 'none') return;
                if (document.activeElement !== state.target) {
                    hideDropdown();
                    return;
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    e.stopPropagation();
                    state.selectedIndex = (state.selectedIndex + 1) % state.options.length;
                    renderDropdown();
                    return;
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    e.stopPropagation();
                    state.selectedIndex = (state.selectedIndex - 1 + state.options.length) % state.options.length;
                    renderDropdown();
                    return;
                }
                if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    e.stopPropagation();
                    chooseOption(state.selectedIndex);
                    return;
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    hideDropdown();
                }
            }, true);

            window.addEventListener('resize', updateDropdownPosition);
            window.addEventListener('scroll', updateDropdownPosition, true);
        };

        window.switchKeepAliveSlot = function(activeSlotId, sessionName) {
            document.querySelectorAll('.keep-alive-slot').forEach(function(slot) {
                if (slot.id === activeSlotId) {
                    slot.classList.add('active');
                } else {
                    slot.classList.remove('active');
                }
            });
            // Instantly toggle sidebar active highlight without waiting for Blazor render
            if (sessionName) {
                document.querySelectorAll('.session-item').forEach(function(item) {
                    var sn = item.getAttribute('data-session-name');
                    if (sn === sessionName) {
                        item.classList.add('active');
                        item.classList.remove('completed');
                    } else if (item.classList.contains('active')) {
                        item.classList.remove('active');
                    }
                });
            }
        };

        // Capture-phase click handler: instantly switch CSS before Blazor processes the event
        document.addEventListener('click', function(e) {
            var item = e.target.closest('.session-item[data-session-name]');
            if (!item || item.closest('.persisted')) return;
            var name = item.getAttribute('data-session-name');
            if (!name) return;
            var slotId = 'slot-' + name.replace(/ /g, '-');
            window.switchKeepAliveSlot(slotId, name);
        }, true);

        window.restoreDraftsAndFocus = function(draftsJson, focusId, selStart, selEnd, forceScroll) {
            window.ensureFiestaMentionAutocomplete();
            window.ensureSlashCommandAutocomplete();
            function doScroll() {
                // Expanded chat: auto-follow with near-bottom tracking
                document.querySelectorAll('.messages').forEach(function(el) {
                    if (!el.__scrollInit) {
                        el.__scrollInit = true;
                        el.__wasAtBottom = true;
                        el.scrollTop = el.scrollHeight;
                        return;
                    }
                    var threshold = 300;
                    var distFromBottom = el.scrollHeight - el.scrollTop - el.clientHeight;
                    var isNearBottom = distFromBottom < threshold;
                    
                    if (isNearBottom) {
                        el.__wasAtBottom = true;
                    }
                    if (distFromBottom > 500) {
                        el.__wasAtBottom = false;
                    }
                    
                    if (forceScroll || isNearBottom || el.__wasAtBottom) {
                        el.scrollTop = el.scrollHeight;
                    }
                });
                // Grid cards: only scroll to bottom on init, never fight user scrolling
                document.querySelectorAll('.card-messages').forEach(function(el) {
                    if (!el.__scrollInit) {
                        el.__scrollInit = true;
                        el.scrollTop = el.scrollHeight;
                    }
                });
            }
            doScroll();
            // Single rAF follow-up is sufficient â€” content is rendered synchronously by Blazor
            requestAnimationFrame(doScroll);
            var drafts = JSON.parse(draftsJson || '{}');
            for (var id in drafts) {
                var el = document.getElementById(id);
                if (el) el.value = drafts[id];
            }
            if (focusId) {
                var fel = document.getElementById(focusId);
                if (fel) {
                    // If element already has focus, don't call focus()/setSelectionRange()
                    // â€” that clobbers the user's active text selection (double-click, drag, etc.)
                    if (document.activeElement !== fel) {
                        fel.focus();
                        fel.setSelectionRange(selStart || 0, selEnd || 0);
                    }
                }
            }
        };

        window.ensureFiestaMentionAutocomplete();

        // === Slash command autocomplete ===
        window.ensureSlashCommandAutocomplete = function() {
            if (window.__slashCmdSetup) return;
            window.__slashCmdSetup = true;

            var COMMANDS = [
                { cmd: '/clear', desc: 'Clear chat history', hasArgs: false },
                { cmd: '/compact', desc: 'Summarize conversation', hasArgs: false },
                { cmd: '/diff', usage: '[args]', desc: 'Show git diff', hasArgs: true },
                { cmd: '/help', desc: 'Show available commands', hasArgs: false },
                { cmd: '/mcp', usage: '[show|add|edit|delete|disable|enable] [server-name] | reload', desc: 'Manage MCP servers', hasArgs: true },
                { cmd: '/new', usage: '[name]', desc: 'Create a new session', hasArgs: true },
                { cmd: '/plugin', usage: '[enable|disable] [plugin-name]', desc: 'Manage installed plugins', hasArgs: true },
                { cmd: '/prompt', usage: '[use|save|delete] [name]', desc: 'List saved prompts', hasArgs: true },
                { cmd: '/reflect', usage: '<goal>', desc: 'Start a reflection cycle', hasArgs: true },
                { cmd: '/rename', usage: '<name>', desc: 'Rename current session', hasArgs: true },
                { cmd: '/sessions', desc: 'List all sessions', hasArgs: false },
                { cmd: '/status', usage: '[path] [--short]', desc: 'Show git status', hasArgs: true },
                { cmd: '/version', desc: 'Show version info', hasArgs: false }
            ];

            var state = { dropdown: null, target: null, options: [], selectedIndex: 0 };
            var USAGE_BY_CMD = {};
            COMMANDS.forEach(function(c) { if (c.usage) USAGE_BY_CMD[c.cmd] = c.usage; });

            function ghostOverlay(el) {
                return el && el.id ? document.getElementById(el.id + '--slash-ghost') : null;
            }

            function removeGhost(el) {
                var o = ghostOverlay(el);
                if (o) o.style.display = 'none';
            }

            function showGhost(el, hintCmd) {
                if (!el) return;
                var text = el.value || '';
                var spaceIdx = text.indexOf(' ');
                if (spaceIdx !== -1 && text.slice(spaceIdx + 1).length > 0) { removeGhost(el); return; }
                var match = hintCmd || null;
                if (!match) {
                    var m = text.trimEnd().match(/^(\/[\w-]+)\s*$/);
                    if (!m) { removeGhost(el); return; }
                    match = COMMANDS.find(function(c) { return c.cmd === m[1].toLowerCase() && c.usage; });
                    if (!match) { removeGhost(el); return; }
                }
                if (!match.usage) { removeGhost(el); return; }

                var overlay = ghostOverlay(el);
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = el.id + '--slash-ghost';
                    overlay.style.cssText =
                        'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;' +
                        'overflow:hidden;white-space:pre-wrap;word-wrap:break-word;';
                    var parent = el.parentNode;
                    if (parent && getComputedStyle(parent).position === 'static') parent.style.position = 'relative';
                    var cs = getComputedStyle(el);
                    overlay.style.padding = cs.padding;
                    overlay.style.font = cs.font;
                    overlay.style.lineHeight = cs.lineHeight;
                    overlay.style.letterSpacing = cs.letterSpacing;
                    overlay.style.borderWidth = cs.borderWidth;
                    overlay.style.borderColor = 'transparent';
                    overlay.style.borderStyle = cs.borderStyle;
                    el.parentNode.appendChild(overlay);
                }

                var typed = el.value || '';
                var remainder = (typed.indexOf(' ') === -1 && match.cmd.indexOf(typed.toLowerCase()) === 0)
                    ? match.cmd.slice(typed.length) + ' ' : '';
                var key = typed + '|' + match.cmd;
                if (overlay._lastKey !== key) {
                    overlay._lastKey = key;
                    overlay.innerHTML =
                        '<span style="visibility:hidden;">' + window.escapeHtml(typed) + '</span>' +
                        '<span style="color:var(--text-muted,#6c7086);">' + window.escapeHtml(remainder + match.usage) + '</span>';
                }
                overlay.style.display = 'block';
            }

            function getSlashContext(el) {
                var text = el && typeof el.value === 'string' ? el.value : '';
                if (text.length === 0 || text.charAt(0) !== '/') return null;
                var spaceIdx = text.indexOf(' ');
                if (spaceIdx === -1) {
                    var cursor = (el && typeof el.selectionStart === 'number') ? el.selectionStart : text.length;
                    return { query: text.slice(0, cursor).slice(1).toLowerCase(), mode: 'filter' };
                }
                var cmdPart = text.slice(0, spaceIdx).toLowerCase();
                if (COMMANDS.some(function(c) { return c.cmd === cmdPart; })) {
                    return { query: cmdPart.slice(1), mode: 'locked' };
                }
                var cursor2 = (el && typeof el.selectionStart === 'number') ? el.selectionStart : text.length;
                var left2 = text.slice(0, cursor2);
                var spIdx = left2.indexOf(' ');
                return spIdx === -1
                    ? { query: left2.slice(1).toLowerCase(), mode: 'filter' }
                    : { query: left2.slice(0, spIdx).slice(1).toLowerCase(), mode: 'locked' };
            }

            function ensureDropdown() {
                if (state.dropdown) return state.dropdown;
                var d = document.createElement('div');
                d.id = 'slash-cmd-autocomplete';
                d.style.cssText =
                    'position:fixed;z-index:10020;display:none;min-width:300px;max-width:420px;max-height:360px;overflow-y:auto;' +
                    'background:var(--bg-tertiary,#1e1e2e);border:1px solid var(--control-border,#45475a);border-radius:8px;' +
                    'box-shadow:0 8px 24px rgba(0,0,0,0.35);padding:6px;font-size:0.9rem;box-sizing:border-box;';
                document.body.appendChild(d);
                d.addEventListener('mousedown', function(e) { if (e.target === d) e.preventDefault(); });
                state.dropdown = d;
                return d;
            }

            function hideDropdown() {
                clearTimeout(state._focusoutTimer);
                if (state.dropdown) { state.dropdown.style.display = 'none'; state.dropdown._posValid = false; }
                state.target = null; state.options = []; state.selectedIndex = 0;
            }
            window._slashHideDropdown = function(el) { if (state.target === el) hideDropdown(); };

            function updateDropdownPosition() {
                if (!state.dropdown || !state.target) return;
                var target = state.target, curHeight = target.offsetHeight;
                if (state.dropdown._posTarget === target && state.dropdown._posValid && state.dropdown._posHeight === curHeight) return;
                var rect = target.getBoundingClientRect();
                var left = Math.max(8, Math.min(rect.left, window.innerWidth - 360));
                var spaceAbove = rect.top - 8, spaceBelow = window.innerHeight - rect.bottom - 8;
                var dd = state.dropdown;
                dd.style.left = left + 'px';
                if (spaceAbove >= 120 || spaceAbove >= spaceBelow) {
                    dd.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
                    dd.style.top = 'auto';
                    dd.style.maxHeight = Math.min(360, Math.max(0, spaceAbove)) + 'px';
                } else {
                    dd.style.top = (rect.bottom + 6) + 'px';
                    dd.style.bottom = 'auto';
                    dd.style.maxHeight = Math.min(360, Math.max(0, spaceBelow)) + 'px';
                }
                dd._posTarget = target; dd._posHeight = curHeight; dd._posValid = true;
            }

            function chooseOption(index) {
                if (!state.target || !state.options[index]) return;
                var target = state.target, option = state.options[index];
                var text = target.value || '';
                var firstSpace = text.indexOf(' ');
                var cmdEnd = firstSpace === -1 ? text.length : firstSpace;
                var suffix = text.slice(cmdEnd);
                if (option.hasArgs) {
                    target.value = option.cmd + (suffix.length === 0 ? ' ' : (suffix.charAt(0) === ' ' ? '' : ' ')) + suffix;
                    var nextCursor = option.cmd.length + 1;
                    target.focus();
                    target.setSelectionRange(nextCursor, nextCursor);
                    hideDropdown();
                    target.dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                    target.value = option.cmd;
                    hideDropdown();
                    target.dispatchEvent(new Event('input', { bubbles: true }));
                    if (_rafPending) { cancelAnimationFrame(_rafPending); _rafPending = 0; }
                    var container = target.closest('.input-row') || target.closest('.card-input');
                    var sendBtn = container && container.querySelector('.send-btn:not(.stop-btn)');
                    if (sendBtn) sendBtn.click();
                }
            }

            function updateSelection(dropdown) {
                var sel = state.selectedIndex;
                if (dropdown._lastSel === sel) return;
                dropdown._lastSel = sel;
                for (var i = 0; i < dropdown.children.length; i++) {
                    dropdown.children[i].style.background = i === sel ? 'var(--hover-bg,#313244)' : 'transparent';
                }
                var selItem = dropdown.children[sel];
                if (selItem) {
                    var itemTop = selItem.offsetTop, itemBottom = itemTop + selItem.offsetHeight;
                    if (itemBottom > dropdown.scrollTop + dropdown.clientHeight) dropdown.scrollTop = itemBottom - dropdown.clientHeight;
                    else if (itemTop < dropdown.scrollTop) dropdown.scrollTop = itemTop;
                }
            }

            function isSlashTarget(el) {
                if (!el || !el.matches) return false;
                if (el._isSlashTarget !== undefined) return el._isSlashTarget;
                return (el._isSlashTarget = el.matches('.input-row textarea, .card-input input'));
            }

            function renderDropdown() {
                var dropdown = ensureDropdown();
                if (!state.target || state.options.length === 0) { hideDropdown(); return; }
                var optKey = state.options.map(function(o) { return o.cmd; }).join(',');
                if (dropdown._lastOptKey !== optKey) {
                    dropdown._lastOptKey = optKey;
                    dropdown._lastSel = -1;
                    dropdown.innerHTML = '';
                    state.options.forEach(function(option, idx) {
                        var item = document.createElement('button');
                        item.type = 'button';
                        var usageHtml = option.usage
                            ? '<span style="margin-left:4px;color:var(--text-muted,#6c7086);font-weight:400;">' +
                              window.escapeHtml(option.usage) + '</span>' : '';
                        item.innerHTML =
                            '<div><span style="font-weight:600;color:var(--text-primary,#cdd6f4);">' +
                            window.escapeHtml(option.cmd) + '</span>' + usageHtml + '</div>' +
                            '<div style="color:var(--text-secondary,#bac2de);font-weight:400;font-size:0.8rem;margin-top:2px;">' +
                            window.escapeHtml(option.desc) + '</div>';
                        item.style.cssText =
                            'display:block;width:100%;text-align:left;border:none;border-radius:6px;padding:8px 10px;' +
                            'font-size:inherit;cursor:pointer;line-height:1.35;background:transparent;';
                        item.addEventListener('mouseenter', function() { state.selectedIndex = idx; updateSelection(dropdown); });
                        item.addEventListener('mousedown', function(ev) { ev.preventDefault(); chooseOption(idx); });
                        dropdown.appendChild(item);
                    });
                }
                updateSelection(dropdown);
                dropdown.style.display = 'block';
                updateDropdownPosition();
            }

            function refreshForTarget(el) {
                if (!isSlashTarget(el)) { hideDropdown(); return; }
                var context = getSlashContext(el);
                if (!context) { hideDropdown(); return; }
                var q = context.query;
                var filtered = context.mode === 'locked'
                    ? COMMANDS.filter(function(c) { return c.cmd.slice(1) === q; })
                    : COMMANDS.filter(function(c) { return c.cmd.slice(1).indexOf(q) === 0; });
                if (filtered.length === 0) { hideDropdown(); return; }
                state.target = el;
                state.options = filtered;
                if (state.selectedIndex >= filtered.length) state.selectedIndex = 0;
                renderDropdown();
            }

            var _rafPending = 0;
            document.addEventListener('input', function(e) {
                var target = e.target;
                if (!isSlashTarget(target)) { removeGhost(target); return; }
                var val = target.value || '';
                if (val === target._lastSlashValue) return;
                target._lastSlashValue = val;
                if (_rafPending) cancelAnimationFrame(_rafPending);
                _rafPending = requestAnimationFrame(function() {
                    _rafPending = 0;
                    refreshForTarget(target);
                    var dropdownVisible = state.dropdown && state.dropdown.style.display !== 'none';
                    if (dropdownVisible && state.options.length === 1 && state.options[0].usage) showGhost(target, state.options[0]);
                    else if (dropdownVisible) removeGhost(target);
                    else showGhost(target);
                });
            }, true);

            // Dismiss dropdown when clicking outside; re-evaluate if clicking into a slash target
            document.addEventListener('click', function(e) {
                if (state.dropdown && state.dropdown.contains(e.target)) return;
                if (isSlashTarget(e.target)) { refreshForTarget(e.target); return; }
                hideDropdown();
            }, true);

            document.addEventListener('focusout', function(e) {
                if (!state.target) return;
                clearTimeout(state._focusoutTimer);
                state._focusoutTimer = setTimeout(function() {
                    if (state.target && document.activeElement !== state.target) hideDropdown();
                }, 100);
            }, true);

            document.addEventListener('keydown', function(e) {
                if (!state.target || !state.dropdown || state.dropdown.style.display === 'none') return;
                if (document.activeElement !== state.target) { hideDropdown(); return; }
                var ctx = getSlashContext(state.target);
                var isLocked = ctx && ctx.mode === 'locked';
                if (e.key === 'ArrowDown' && !isLocked) {
                    e.preventDefault(); e.stopPropagation();
                    state.selectedIndex = (state.selectedIndex + 1) % state.options.length;
                    renderDropdown(); return;
                }
                if (e.key === 'ArrowUp' && !isLocked) {
                    e.preventDefault(); e.stopPropagation();
                    state.selectedIndex = (state.selectedIndex - 1 + state.options.length) % state.options.length;
                    renderDropdown(); return;
                }
                if ((e.key === 'Tab' || e.key === 'Enter') && !isLocked) {
                    e.preventDefault(); e.stopPropagation();
                    chooseOption(state.selectedIndex); return;
                }
                if (e.key === 'Escape') { e.preventDefault(); e.stopPropagation(); hideDropdown(); }
            }, true);

            function invalidateAndReposition() {
                if (state.dropdown) state.dropdown._posValid = false;
                updateDropdownPosition();
            }
            window.addEventListener('resize', invalidateAndReposition);
            window.addEventListener('scroll', invalidateAndReposition, true);
        };
        window.ensureSlashCommandAutocomplete();

        // === Full-screen image viewer with zoom/pan ===
        (function() {
            var overlay, img, closeBtn;
            var scale = 1, panX = 0, panY = 0, dragging = false, startX, startY, startPanX, startPanY;
            var pinchStartDist = 0, pinchStartScale = 1;

            function create() {
                overlay = document.createElement('div');
                overlay.className = 'image-viewer-overlay';
                closeBtn = document.createElement('button');
                closeBtn.className = 'image-viewer-close';
                closeBtn.innerHTML = 'âœ•';
                closeBtn.addEventListener('click', function(e) { e.stopPropagation(); close(); });
                img = document.createElement('img');
                overlay.appendChild(closeBtn);
                overlay.appendChild(img);
                overlay.addEventListener('click', function(e) { if (e.target === overlay) close(); });
                img.addEventListener('click', function(e) { e.stopPropagation(); });

                // Mouse zoom
                overlay.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    var rect = img.getBoundingClientRect();
                    var mx = e.clientX - rect.left, my = e.clientY - rect.top;
                    var oldScale = scale;
                    scale *= e.deltaY < 0 ? 1.15 : 1/1.15;
                    scale = Math.max(0.5, Math.min(scale, 20));
                    panX -= mx * (scale - oldScale);
                    panY -= my * (scale - oldScale);
                    applyTransform();
                }, { passive: false });

                // Mouse drag
                img.addEventListener('mousedown', function(e) {
                    if (e.button !== 0) return;
                    e.preventDefault();
                    dragging = true; startX = e.clientX; startY = e.clientY;
                    startPanX = panX; startPanY = panY;
                    img.classList.add('grabbing');
                });
                document.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    panX = startPanX + (e.clientX - startX);
                    panY = startPanY + (e.clientY - startY);
                    applyTransform();
                });
                document.addEventListener('mouseup', function() {
                    dragging = false;
                    if (img) img.classList.remove('grabbing');
                });

                // Touch pinch-to-zoom + pan
                overlay.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        pinchStartDist = getTouchDist(e.touches);
                        pinchStartScale = scale;
                    } else if (e.touches.length === 1 && e.target === img) {
                        dragging = true;
                        startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                        startPanX = panX; startPanY = panY;
                    }
                }, { passive: false });
                overlay.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        var dist = getTouchDist(e.touches);
                        scale = pinchStartScale * (dist / pinchStartDist);
                        scale = Math.max(0.5, Math.min(scale, 20));
                        applyTransform();
                    } else if (e.touches.length === 1 && dragging) {
                        e.preventDefault();
                        panX = startPanX + (e.touches[0].clientX - startX);
                        panY = startPanY + (e.touches[0].clientY - startY);
                        applyTransform();
                    }
                }, { passive: false });
                overlay.addEventListener('touchend', function(e) {
                    if (e.touches.length < 2) { pinchStartDist = 0; }
                    if (e.touches.length === 0) { dragging = false; }
                });

                document.body.appendChild(overlay);
            }

            function getTouchDist(touches) {
                var dx = touches[0].clientX - touches[1].clientX;
                var dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx*dx + dy*dy);
            }

            function applyTransform() {
                img.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
            }

            function open(src) {
                if (!overlay) create();
                scale = 1; panX = 0; panY = 0;
                img.style.transform = '';
                img.src = src;
                overlay.style.display = 'flex';
                requestAnimationFrame(function() { overlay.classList.add('visible'); });
            }

            function close() {
                if (!overlay) return;
                overlay.classList.remove('visible');
                setTimeout(function() { overlay.style.display = 'none'; img.src = ''; }, 200);
            }

            // Escape key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay && overlay.style.display === 'flex') {
                    e.preventDefault(); e.stopPropagation(); close();
                }
            }, true);

            // Delegated click on chat images
            document.addEventListener('click', function(e) {
                var t = e.target;
                if (t.tagName !== 'IMG') return;
                if (t.closest('.markdown-body') || t.closest('.tool-image-result') || t.closest('.action-output') || t.closest('.action-expanded-result') || t.closest('.image-bubble-content')) {
                    e.preventDefault(); e.stopPropagation();
                    open(t.src);
                }
            });

            window.__imageViewer = { open: open, close: close };
        })();
    </script>

</body>

</html>
