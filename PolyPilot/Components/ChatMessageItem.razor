@using PolyPilot.Models
@using PolyPilot.Services
@using PolyPilot.Components
@using Microsoft.JSInterop

@switch (Message.MessageType)
{
    case ChatMessageType.User:
        <div class="chat-msg user">
            @if (!Compact)
            {
                <div class="chat-msg-avatar">
                    @if (!string.IsNullOrEmpty(UserAvatarUrl))
                    {
                        <img src="@UserAvatarUrl" width="36" height="36" alt="You" class="user-avatar-img" />
                    }
                    else
                    {
                        <text>üë§</text>
                    }
                </div>
            }
            <div class="chat-msg-content">
                @if (Compact)
                {
                    <span class="chat-msg-role">You</span>
                }
                <div class="chat-msg-text">@((MarkupString)ChatMessageList.FormatUserMessage(Message.Content))</div>
                @if (!Compact)
                {
                    <div class="chat-msg-time">@Message.Timestamp.ToShortTimeString()</div>
                }
            </div>
        </div>
        break;

    case ChatMessageType.Assistant:
        <div class="chat-msg assistant @(IsStreaming ? "streaming" : "")">
            @if (!Compact)
            {
                <div class="chat-msg-avatar"><img src="PolyPilot_logo.png" width="36" height="36" alt="PolyPilot" /></div>
            }
            <div class="chat-msg-content">
                @if (Compact)
                {
                    <span class="chat-msg-role">AI</span>
                }
                <div class="chat-msg-text markdown-body">@((MarkupString)ChatMessageList.RenderMarkdown(Message.Content))</div>
                @if (!Compact && !IsStreaming)
                {
                    <div class="chat-msg-time">@Message.Timestamp.ToShortTimeString()</div>
                }
            </div>
        </div>
        break;

    case ChatMessageType.Reasoning:
        @if (Compact)
        {
            <div class="chat-msg reasoning">
                <span class="chat-msg-role">üí°</span>
                <span class="chat-msg-text">@(Message.IsComplete ? "Thought" : "Thinking...")</span>
            </div>
        }
        else
        {
            <div class="reasoning-block @(Message.IsCollapsed && ChatMessageList.LineCount(Message.Content) > 5 ? "collapsed" : "")">
                <button class="reasoning-header" @onclick="() => Message.IsCollapsed = !Message.IsCollapsed">
                    <span class="reasoning-title">üí° @(Message.IsComplete ? "Thought" : "Thinking...")</span>
                    @if (ChatMessageList.LineCount(Message.Content) > 5)
                    {
                        <span class="collapse-icon">@(Message.IsCollapsed ? "‚ñ∂" : "‚ñº")</span>
                    }
                </button>
                @if (!Message.IsCollapsed || ChatMessageList.LineCount(Message.Content) <= 5)
                {
                    <div class="reasoning-content">@Message.Content</div>
                }
                else
                {
                    <div class="reasoning-content preview">@ChatMessageList.FirstLines(Message.Content, 3)</div>
                }
            </div>
        }
        break;

    case ChatMessageType.ToolCall:
        @if (Compact)
        {
            <div class="chat-msg tool">
                <span class="chat-msg-role">üîß</span>
                <span class="chat-msg-text">@ChatMessageList.FormatToolName(Message.ToolName ?? "tool") @(Message.IsComplete ? (Message.IsSuccess ? "‚úì" : "‚úó") : "‚Ä¶")</span>
            </div>
        }
        else if (Message.ToolName == "task_complete")
        {
            <div class="task-complete-card">
                ‚úÖ
                <span class="task-complete-text">@(string.IsNullOrEmpty(Message.Content) || ChatMessageList.IsUnusableResult(Message.Content) ? "Task complete" : Message.Content)</span>
            </div>
        }
        else
        {
            @* Unified command box: header + input always visible, output collapsible *@
            <div class="action-box @(ChatMessageList.GetActionLabel(Message.ToolName ?? "").CssClass) @(Message.IsComplete ? (Message.IsSuccess ? "done" : "failed") : "running")">
                <div class="action-header">
                    <span class="action-dot"></span>
                    <span class="action-label">@(ChatMessageList.GetActionLabel(Message.ToolName ?? "").Label)</span>
                    <span class="action-desc">@ChatMessageList.FormatActionDescription(Message.ToolName ?? "", Message.ToolInput, Message.Content, Message.IsComplete)</span>
                </div>
                @if (!string.IsNullOrEmpty(Message.ToolInput) && Message.ToolName != "bash")
                {
                    <div class="action-input">
                        <pre>@ChatMessageList.FormatToolInputExpanded(Message.ToolName ?? "", Message.ToolInput)</pre>
                    </div>
                }
                @if (Message.IsComplete && !string.IsNullOrEmpty(Message.Content) && !ChatMessageList.IsUnusableResult(Message.Content))
                {
                    <div class="action-output-toggle" @onclick="() => Message.IsCollapsed = !Message.IsCollapsed" @onclick:stopPropagation="true">
                        <span class="toggle-icon">@(Message.IsCollapsed ? "‚ñ∂" : "‚ñº")</span>
                        <span class="toggle-label">Output</span>
                        @if (ChatMessageList.GetImagePath(Message.Content) is string imgPath)
                        {
                            <span class="output-hint">üñº image</span>
                        }
                        else
                        {
                            <span class="output-hint">@ChatMessageList.LineCount(Message.Content) line@(ChatMessageList.LineCount(Message.Content) != 1 ? "s" : "")</span>
                        }
                    </div>
                    @if (!Message.IsCollapsed)
                    {
                        @if (ChatMessageList.GetImagePath(Message.Content) is string imgPath2 && ChatMessageList.FileToDataUri(imgPath2) is string dataUri2)
                        {
                            <div class="action-output">
                                <img src="@dataUri2" alt="@System.IO.Path.GetFileName(imgPath2)" />
                            </div>
                        }
                        else
                        {
                            <div class="action-output">
                                <pre>@ChatMessageList.TruncateResult(Message.Content)</pre>
                            </div>
                        }
                    }
                }
            </div>
        }
        break;

    case ChatMessageType.Error:
        <div class="@(Compact ? "chat-msg error" : "error-card")">
            @if (Compact)
            {
                <span class="chat-msg-role">‚ö†Ô∏è</span>
                <span class="chat-msg-text">@Message.Content</span>
            }
            else
            {
                <span class="error-icon">‚ö†Ô∏è</span>
                <span class="error-text">@Message.Content</span>
            }
        </div>
        break;

    case ChatMessageType.System:
        <div class="chat-msg system">
            <div class="system-text markdown-body">@((MarkupString)ChatMessageList.RenderMarkdown(Message.Content))</div>
        </div>
        break;

    case ChatMessageType.ShellOutput:
        <div class="chat-msg shell-output">
            <pre class="shell-output-text">@Message.Content</pre>
        </div>
        break;

    case ChatMessageType.Diff:
        <div class="chat-msg diff-msg">
            <DiffView RawDiff="@Message.Content" />
        </div>
        break;

    case ChatMessageType.Reflection:
        @if (TryGetReflectionData(Message.Content, out var rData))
        {
            <div class="chat-msg reflection-card">
                <div class="reflection-header">
                    <span class="reflection-pill-small">Reflection Cycle</span>
                    <span>Iteration @rData.Iteration / @rData.Max</span>
                </div>
                <div class="reflection-body">
                    <div class="reflection-goal">Target: @rData.Goal</div>
                    <div class="reflection-status">
                        <span>@rData.Status</span>
                    </div>
                    <div class="reflection-progress-track">
                        <div class="reflection-progress-bar" style="width: @(rData.Max > 0 ? Math.Min(100, (double)rData.Iteration / rData.Max * 100) : 0)%"></div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="chat-msg reflection">
                <div class="reflection-text">@Message.Content</div>
            </div>
        }
        break;
}

@code {
    [Parameter] public ChatMessage Message { get; set; } = default!;
    [Parameter] public bool Compact { get; set; }
    [Parameter] public bool IsStreaming { get; set; }
    [Parameter] public string? UserAvatarUrl { get; set; }

    private bool TryGetReflectionData(string content, out ReflectionData data)
    {
        data = default;
        if (string.IsNullOrWhiteSpace(content) || !content.TrimStart().StartsWith("{")) return false;
        try
        {
            var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            data = System.Text.Json.JsonSerializer.Deserialize<ReflectionData>(content, options);
            return true;
        }
        catch
        {
            return false;
        }
    }

    private struct ReflectionData
    {
        public int Iteration { get; set; }
        public int Max { get; set; }
        public string Goal { get; set; }
        public string Status { get; set; }
    }
}
