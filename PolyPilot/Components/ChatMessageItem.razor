@using PolyPilot.Models
@using PolyPilot.Services
@using PolyPilot.Components
@using Microsoft.JSInterop

@switch (Message.MessageType)
{
    case ChatMessageType.User:
        <div class="chat-msg user">
            @if (!Compact)
            {
                <div class="chat-msg-avatar">üë§</div>
            }
            <div class="chat-msg-content">
                @if (Compact)
                {
                    <span class="chat-msg-role">You</span>
                }
                <div class="chat-msg-text">@((MarkupString)ChatMessageList.FormatUserMessage(Message.Content))</div>
                @if (!Compact)
                {
                    <div class="chat-msg-time">@Message.Timestamp.ToString("HH:mm")</div>
                }
            </div>
        </div>
        break;

    case ChatMessageType.Assistant:
        <div class="chat-msg assistant @(IsStreaming ? "streaming" : "")">
            @if (!Compact)
            {
                <div class="chat-msg-avatar"><img src="PolyPilot_logo.png" width="22" height="22" alt="PolyPilot" /></div>
            }
            <div class="chat-msg-content">
                @if (Compact)
                {
                    <span class="chat-msg-role">AI</span>
                }
                <div class="chat-msg-text markdown-body">@((MarkupString)ChatMessageList.RenderMarkdown(Message.Content))</div>
                @if (!Compact && !IsStreaming)
                {
                    <div class="chat-msg-time">@Message.Timestamp.ToString("HH:mm")</div>
                }
            </div>
        </div>
        break;

    case ChatMessageType.Reasoning:
        @if (Compact)
        {
            <div class="chat-msg reasoning">
                <span class="chat-msg-role">üí°</span>
                <span class="chat-msg-text">@(Message.IsComplete ? "Thought" : "Thinking...")</span>
            </div>
        }
        else
        {
            <div class="reasoning-block @(Message.IsCollapsed && ChatMessageList.LineCount(Message.Content) > 5 ? "collapsed" : "")">
                <button class="reasoning-header" @onclick="() => Message.IsCollapsed = !Message.IsCollapsed">
                    <span class="reasoning-title">üí° @(Message.IsComplete ? "Thought" : "Thinking...")</span>
                    @if (ChatMessageList.LineCount(Message.Content) > 5)
                    {
                        <span class="collapse-icon">@(Message.IsCollapsed ? "‚ñ∂" : "‚ñº")</span>
                    }
                </button>
                @if (!Message.IsCollapsed || ChatMessageList.LineCount(Message.Content) <= 5)
                {
                    <div class="reasoning-content">@Message.Content</div>
                }
                else
                {
                    <div class="reasoning-content preview">@ChatMessageList.FirstLines(Message.Content, 3)</div>
                }
            </div>
        }
        break;

    case ChatMessageType.ToolCall:
        @if (Compact)
        {
            <div class="chat-msg tool">
                <span class="chat-msg-role">üîß</span>
                <span class="chat-msg-text">@ChatMessageList.FormatToolName(Message.ToolName ?? "tool") @(Message.IsComplete ? (Message.IsSuccess ? "‚úì" : "‚úó") : "‚Ä¶")</span>
            </div>
        }
        else if (Message.ToolName == "task_complete")
        {
            <div class="task-complete-card">
                ‚úÖ
                <span class="task-complete-text">@(string.IsNullOrEmpty(Message.Content) || ChatMessageList.IsUnusableResult(Message.Content) ? "Task complete" : Message.Content)</span>
            </div>
        }
        else
        {
            <div class="action-item @(ChatMessageList.GetActionLabel(Message.ToolName ?? "").CssClass) @(Message.IsComplete ? (Message.IsSuccess ? "done" : "failed") : "running")" @onclick="() => Message.IsCollapsed = !Message.IsCollapsed">
                <span class="action-dot"></span>
                <span class="action-label">@(ChatMessageList.GetActionLabel(Message.ToolName ?? "").Label)</span>
                <span class="action-desc">@ChatMessageList.FormatActionDescription(Message.ToolName ?? "", Message.ToolInput, Message.Content, Message.IsComplete)</span>
                @if (Message.IsComplete && !string.IsNullOrEmpty(Message.Content) && !ChatMessageList.IsUnusableResult(Message.Content))
                {
                    @if (ChatMessageList.GetImagePath(Message.Content) is string imgPath)
                    {
                        <span class="action-detail-hint">üñº</span>
                    }
                    else if (ChatMessageList.LineCount(Message.Content) > 0)
                    {
                        <span class="action-detail-hint">‚Ü≥ @ChatMessageList.LineCount(Message.Content) line@(ChatMessageList.LineCount(Message.Content) != 1 ? "s" : "")</span>
                    }
                }
            </div>
            @if (!Message.IsCollapsed)
            {
                @if (!string.IsNullOrEmpty(Message.ToolInput))
                {
                    <div class="action-expanded-input">
                        <pre>@ChatMessageList.FormatToolInputExpanded(Message.ToolName ?? "", Message.ToolInput)</pre>
                    </div>
                }
                @if (Message.IsComplete && !string.IsNullOrEmpty(Message.Content) && !ChatMessageList.IsUnusableResult(Message.Content))
                {
                    @if (ChatMessageList.GetImagePath(Message.Content) is string imgPath2 && ChatMessageList.FileToDataUri(imgPath2) is string dataUri2)
                    {
                        <div class="action-expanded-result">
                            <img src="@dataUri2" alt="@System.IO.Path.GetFileName(imgPath2)" />
                        </div>
                    }
                    else
                    {
                        <div class="action-expanded-result">
                            <pre>@ChatMessageList.TruncateResult(Message.Content)</pre>
                        </div>
                    }
                }
            }
        }
        break;

    case ChatMessageType.Error:
        <div class="@(Compact ? "chat-msg error" : "error-card")">
            @if (Compact)
            {
                <span class="chat-msg-role">‚ö†Ô∏è</span>
                <span class="chat-msg-text">@Message.Content</span>
            }
            else
            {
                <span class="error-icon">‚ö†Ô∏è</span>
                <span class="error-text">@Message.Content</span>
            }
        </div>
        break;

    case ChatMessageType.System:
        <div class="chat-msg system">
            <div class="system-text">@Message.Content</div>
        </div>
        break;

    case ChatMessageType.ShellOutput:
        <div class="chat-msg shell-output">
            <pre class="shell-output-text">@Message.Content</pre>
        </div>
        break;
}

@code {
    [Parameter] public ChatMessage Message { get; set; } = default!;
    [Parameter] public bool Compact { get; set; }
    [Parameter] public bool IsStreaming { get; set; }
}
