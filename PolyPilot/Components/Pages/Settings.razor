@page "/settings"
@using PolyPilot.Services
@using PolyPilot.Models
@inject CopilotService CopilotService
@inject ServerManager ServerManager
@inject DevTunnelService DevTunnelService
@inject WsBridgeServer WsBridgeServer
@inject TailscaleService TailscaleService
@inject QrScannerService QrScanner
@inject GitAutoUpdateService GitAutoUpdate
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable

<div class="settings-page">
    <div class="settings-header">
        <div class="header-row">
            <h2>Settings</h2>
            <div class="header-right">
                <div class="settings-search">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" class="search-input" id="settings-search" placeholder="Search..." />
                    @if (!string.IsNullOrEmpty(searchQuery))
                    {
                        <button class="search-clear" @onclick="ClearSearch">Ã—</button>
                    }
                </div>
                <div class="info-popover">
                    <span class="info-trigger" title="Connection & shortcuts">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    </span>
                    <div class="info-panel">
                        <div class="info-row"><span class="info-label">Mode</span><span class="info-value">@CopilotService.CurrentMode</span></div>
                        <div class="info-row"><span class="info-label">Status</span><span class="info-value">@(CopilotService.IsInitialized ? "Connected" : "Disconnected")</span></div>
                        @if (PlatformHelper.IsDesktop)
                        {
                            <div class="info-divider"></div>
                            <div class="info-row"><span class="info-label">âŒ˜E</span><span class="info-value">Expand/collapse</span></div>
                            <div class="info-row"><span class="info-label">Esc</span><span class="info-value">Collapse to grid</span></div>
                            <div class="info-row"><span class="info-label">Tab</span><span class="info-value">Next session</span></div>
                            <div class="info-row"><span class="info-label">Aâˆ’/A+</span><span class="info-value">Font size</span></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-group @(GroupVisible("connection") ? "" : "search-hidden")">
        <h2 class="group-title">Connection</h2>

    @if (PlatformHelper.AvailableModes.Length > 1)
    {
        <div class="settings-section @(SectionVisible("transport mode embedded persistent remote") ? "" : "search-hidden") @((settings.Mode == ConnectionMode.Remote || (PlatformHelper.IsDesktop && (settings.Mode == ConnectionMode.Embedded || settings.Mode == ConnectionMode.Persistent))) ? "mode-linked-root" : "")">
            <h3>Transport Mode</h3>
            <div class="mode-cards">
                @foreach (var mode in PlatformHelper.AvailableModes)
                {
                    <div class="mode-card @(settings.Mode == mode ? "selected" : "")"
                         @onclick="() => SetMode(mode)">
                        <div class="mode-icon">@GetModeIcon(mode)</div>
                        <div class="mode-title">@mode</div>
                        <div class="mode-desc">@GetModeDescription(mode)</div>
                    </div>
                }
            </div>
        </div>
    }

    @if (settings.Mode == ConnectionMode.Persistent)
    {
        <div class="mode-linked-panel @(SectionVisible("persistent server port start stop pid") ? "" : "search-hidden")">
            <h3>Persistent Server</h3>
            <div class="server-controls">
                <div class="server-status">
                    <span class="status-dot @(serverAlive ? "alive" : "dead")"></span>
                    <span>@(serverAlive ? $"Running on port {settings.Port}" : "Not running")</span>
                    @if (ServerManager.ServerPid != null && serverAlive)
                    {
                        <span class="pid-label">PID @ServerManager.ServerPid</span>
                    }
                </div>
                <div class="port-input">
                    <label>Port:</label>
                    <input type="number" @bind="settings.Port" min="1024" max="65535" />
                </div>
                <div class="server-buttons">
                    @if (!serverAlive)
                    {
                        <button class="start-btn" @onclick="StartServer" disabled="@starting">
                            @if (starting) {<svg class="icon spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><text> Starting...</text>}
                            else {<svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg><text> Start Server</text>}
                        </button>
                    }
                    else
                    {
                        <button class="stop-btn" @onclick="StopServer"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg> Stop Server</button>
                    }
                </div>
            </div>
        </div>
    }

    @if (PlatformHelper.IsDesktop && (settings.Mode == ConnectionMode.Embedded || settings.Mode == ConnectionMode.Persistent))
    {
        <div class="mode-linked-panel @(SectionVisible("devtunnel share tunnel remote mobile qr") ? "" : "search-hidden")">
            <h3>Share via DevTunnel</h3>
                @if (!devTunnelAvailable)
                {
                    <div class="tunnel-warning">
                        <p><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> <code>devtunnel</code> CLI not found. Install it to share your server remotely.</p>
                        <p class="hint">Run: <code>winget install Microsoft.devtunnel</code> (Windows) or <code>brew install --cask devtunnel</code> (macOS)</p>
                    </div>
                }
                else
                {
                    <div class="tunnel-controls">
                        <div class="server-status">
                            <span class="status-dot @(DevTunnelService.State == TunnelState.Running ? "alive" : DevTunnelService.State == TunnelState.Error ? "error" : "dead")"></span>
                            <span>@GetTunnelStatusText()</span>
                        </div>

                        @if (DevTunnelService.State == TunnelState.NotStarted || DevTunnelService.State == TunnelState.Error)
                        {
                            @if (!tunnelLoggedIn)
                            {
                                <button class="start-btn" @onclick="TunnelLogin" disabled="@tunnelBusy">
                                    @if (tunnelBusy) {<svg class="icon spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><text> Authenticating...</text>}
                                    else {<svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg><text> Login with GitHub</text>}
                                </button>
                            }
                            else
                            {
                                <button class="start-btn" @onclick="StartTunnel" disabled="@tunnelBusy">
                                    @if (tunnelBusy) {<svg class="icon spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><text> Starting tunnel...</text>}
                                    else {<svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2 15 22 11 13 2 9z"/></svg><text> Start Tunnel</text>}
                                </button>
                            }

                            @if (DevTunnelService.State == TunnelState.Error)
                            {
                                <p class="tunnel-error">@DevTunnelService.ErrorMessage</p>
                            }
                        }
                        else if (DevTunnelService.State == TunnelState.Running)
                        {
                            <div class="tunnel-url-section">
                                <div class="tunnel-url">
                                    <code>@DevTunnelService.TunnelUrl</code>
                                    <button class="copy-btn" @onclick="CopyTunnelUrl" title="Copy URL"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                                </div>

                                @if (!string.IsNullOrEmpty(DevTunnelService.AccessToken))
                                {
                                    <div class="tunnel-token">
                                        <label>Token:</label>
                                        <code class="token-value @(showToken ? "" : "blurred")">@DevTunnelService.AccessToken</code>
                                        <button class="copy-btn" @onclick="() => showToken = !showToken" title="@(showToken ? "Hide" : "Reveal")">@if (showToken) {<svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>} else {<svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>}</button>
                                        <button class="copy-btn" @onclick="CopyTunnelToken" title="Copy Token"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(qrCodeDataUri))
                                {
                                    <div class="qr-code">
                                        <img src="@qrCodeDataUri" alt="QR Code" />
                                        <p class="qr-hint">Scan with PolyPilot on iOS/Android to connect</p>
                                    </div>
                                }
                            </div>

                            <button class="stop-btn" @onclick="StopTunnel"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg> Stop Tunnel</button>
                        }
                        else
                        {
                            <p class="tunnel-status-text">@GetTunnelStatusText()</p>
                        }
                    </div>
                }
            </div>
        }

    @if (PlatformHelper.IsDesktop && (settings.Mode == ConnectionMode.Embedded || settings.Mode == ConnectionMode.Persistent))
    {
        <div class="mode-linked-panel mode-linked-last @(SectionVisible("direct connection sharing tailscale lan password qr") ? "" : "search-hidden")">
            <h3>Direct Connection</h3>
            <div class="tunnel-controls">
                <p class="mode-hint">Share your server directly over LAN, Tailscale, or VPN â€” no DevTunnel needed.</p>

                <div class="url-input">
                    <label>Password:</label>
                    <input type="password" @bind="settings.ServerPassword" placeholder="Set a password for remote access" class="form-input wide" />
                </div>

                @if (!WsBridgeServer.IsRunning)
                {
                    <button class="start-btn" @onclick="StartDirectSharing" disabled="@(string.IsNullOrWhiteSpace(settings.ServerPassword))">
                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2 15 22 11 13 2 9z"/></svg> Enable Direct Sharing
                    </button>
                    @if (string.IsNullOrWhiteSpace(settings.ServerPassword))
                    {
                        <p class="hint">Set a password above to enable direct sharing.</p>
                    }
                }
                else
                {
                    <div class="server-status">
                        <span class="status-dot alive"></span>
                        <span>Listening on port @DevTunnelService.BridgePort</span>
                    </div>

                    <div class="tunnel-url-section">
                        @if (TailscaleService.IsRunning)
                        {
                            <div class="tunnel-url">
                                <label>Tailscale:</label>
                                <code>http://@(TailscaleService.MagicDnsName ?? TailscaleService.TailscaleIp):@DevTunnelService.BridgePort</code>
                                <button class="copy-btn" @onclick="CopyDirectUrl" title="Copy URL"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                            </div>
                        }
                        @foreach (var ip in localIps)
                        {
                            <div class="tunnel-url">
                                <label>LAN:</label>
                                <code>http://@ip:@DevTunnelService.BridgePort</code>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(directQrCodeDataUri))
                        {
                            <div class="qr-code">
                                <img src="@directQrCodeDataUri" alt="QR Code" />
                                <p class="qr-hint">Scan with PolyPilot on iOS/Android to connect</p>
                            </div>
                        }
                    </div>

                    <button class="stop-btn" @onclick="StopDirectSharing"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg> Stop Direct Sharing</button>
                }
            </div>
        </div>
    }


    @if (settings.Mode == ConnectionMode.Remote)
    {
        <div class="mode-linked-panel mode-linked-last @(SectionVisible("remote server url token connect") ? "" : "search-hidden")">
            <h3>Remote Server</h3>
            <div class="remote-controls">
                <p class="mode-hint">Connect to a Copilot server running on another machine (via DevTunnel URL).</p>

                @if (PlatformHelper.IsMobile)
                {
                    <button class="scan-btn" @onclick="ScanQrCode">
                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Scan QR Code
                    </button>
                }

                <div class="url-input">
                    <label>Server URL:</label>
                    <input type="text" @bind="settings.RemoteUrl" placeholder="https://xxx.devtunnels.ms" class="form-input wide" />
                </div>
                <div class="url-input">
                    <label>Token:</label>
                    <input type="password" @bind="settings.RemoteToken" placeholder="Tunnel access token" class="form-input wide" />
                </div>
            </div>
        </div>
    }

    <div class="settings-section">
        <div class="save-row">
            <button class="save-btn" @onclick="SaveAndApply">
                <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save &amp; Reconnect
            </button>
        </div>
    </div>
    </div>

    @if (settings.Mode != ConnectionMode.Remote && settings.Mode != ConnectionMode.Demo)
    {
    <div class="settings-group @(GroupVisible("cli copilot") ? "" : "search-hidden")">
        <h2 class="group-title">Copilot CLI</h2>
        <div class="settings-section @(SectionVisible("cli source built-in system version binary copilot") ? "" : "search-hidden")">
            <div class="cli-cards">
                <div class="cli-card @(settings.CliSource == CliSourceMode.BuiltIn ? "selected" : "") @(cliInfo.builtInPath == null ? "disabled" : "")"
                     @onclick="() => SetCliSource(CliSourceMode.BuiltIn)">
                    <div class="cli-card-icon">ðŸ“¦</div>
                    <div class="cli-card-label">Built-in</div>
                    <div class="cli-card-ver">v@(cliInfo.builtInVersion ?? "â€”")</div>
                </div>
                <div class="cli-card @(settings.CliSource == CliSourceMode.System ? "selected" : "") @(cliInfo.systemPath == null ? "disabled" : "")"
                     @onclick="() => SetCliSource(CliSourceMode.System)">
                    <div class="cli-card-icon">ðŸ’»</div>
                    <div class="cli-card-label">System</div>
                    <div class="cli-card-ver">v@(cliInfo.systemVersion ?? "â€”")</div>
                </div>
            </div>
            @if (cliSourceChanged)
            {
                <div class="cli-restart-hint">âŸ³ Restart the app to apply the change</div>
            }
            @if (settings.CliSource == CliSourceMode.System && cliInfo.systemPath != null)
            {
                <div class="cli-path-info" title="@cliInfo.systemPath">@ShortenPath(cliInfo.systemPath)</div>
            }
            @if (settings.CliSource == CliSourceMode.System && cliInfo.systemPath == null)
            {
                <div class="cli-path-warn">âš  No system CLI found â€” will fall back to built-in</div>
            }
        </div>
    </div>
    }

    <div class="settings-group @(GroupVisible("ui") ? "" : "search-hidden")">
        <h2 class="group-title">UI</h2>

        <div class="settings-section @(SectionVisible("theme appearance dark light solarized system") ? "" : "search-hidden")">
            <h3>Theme</h3>
            <div class="layout-option">
                <label>Appearance:</label>
                <div class="layout-cards">
                    @foreach (var theme in Enum.GetValues<UiTheme>())
                    {
                        <div class="layout-card @(settings.Theme == theme ? "selected" : "")"
                             @onclick="() => SetTheme(theme)">
                            <div class="theme-preview @GetThemePreviewClass(theme)">
                                <div class="tp-bar"></div>
                                <div class="tp-content">
                                    <div class="tp-line tp-line-1"></div>
                                    <div class="tp-line tp-line-2"></div>
                                </div>
                            </div>
                            <div class="layout-label">@GetThemeLabel(theme)</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="settings-section @(SectionVisible("chat message layout default reversed both left") ? "" : "search-hidden")">
            <h3>Chat</h3>
            <div class="layout-option">
                <label>Message layout:</label>
                <div class="layout-cards">
                    @foreach (var layout in Enum.GetValues<ChatLayout>())
                    {
                        <div class="layout-card @(settings.ChatLayout == layout ? "selected" : "")"
                             @onclick="() => SetChatLayout(layout)">
                            <div class="layout-preview">
                                @switch (layout)
                                {
                                    case ChatLayout.Default:
                                        <div class="lp-row lp-left"><span class="lp-bot"></span><span class="lp-bubble lp-ai"></span></div>
                                        <div class="lp-row lp-right"><span class="lp-bubble lp-you"></span><span class="lp-user"></span></div>
                                        break;
                                    case ChatLayout.Reversed:
                                        <div class="lp-row lp-right"><span class="lp-bubble lp-ai"></span><span class="lp-bot"></span></div>
                                        <div class="lp-row lp-left"><span class="lp-user"></span><span class="lp-bubble lp-you"></span></div>
                                        break;
                                    case ChatLayout.BothLeft:
                                        <div class="lp-row lp-left"><span class="lp-bot"></span><span class="lp-bubble lp-ai"></span></div>
                                        <div class="lp-row lp-left"><span class="lp-user"></span><span class="lp-bubble lp-you"></span></div>
                                        break;
                                }
                            </div>
                            <div class="layout-label">@GetLayoutLabel(layout)</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (GitAutoUpdate.IsAvailable)
    {
    <div class="settings-group @(GroupVisible("developer") ? "" : "search-hidden")">
        <h2 class="group-title">Developer</h2>

        <div class="settings-section @(SectionVisible("auto update main git watch relaunch rebuild") ? "" : "search-hidden")">
            <h3>Auto-Update from Main</h3>
            <p class="section-desc">Watches <code>origin/main</code> for new commits every 30s. When changes are detected, automatically pulls, rebuilds, and relaunches.</p>
            <div class="auto-update-row">
                <label class="toggle-label">
                    <span class="toggle-track @(GitAutoUpdate.IsEnabled ? "on" : "")" @onclick="ToggleAutoUpdate">
                        <span class="toggle-thumb"></span>
                    </span>
                    <span>@(GitAutoUpdate.IsEnabled ? "Enabled" : "Disabled")</span>
                </label>
                @if (GitAutoUpdate.IsEnabled && !string.IsNullOrEmpty(GitAutoUpdate.Status))
                {
                    <span class="auto-update-status">@GitAutoUpdate.Status</span>
                }
            </div>
        </div>
    </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-toast @statusClass">@(statusClass == "success" ? "âœ“ " : statusClass == "error" ? "âœ— " : "")@statusMessage</div>
    }
</div>

@code {
    private ConnectionSettings settings = new();
    private string? statusMessage;
    private string statusClass = "";
    private bool serverAlive;
    private bool starting;
    private bool devTunnelAvailable;
    private bool tunnelLoggedIn;
    private bool tunnelBusy;
    private bool showToken;
    private string? qrCodeDataUri;
    private string? directQrCodeDataUri;
    private List<string> localIps = new();
    private CancellationTokenSource? _statusCts;
    private string searchQuery = "";
    private DotNetObjectReference<Settings>? _selfRef;
    private (string? builtInPath, string? builtInVersion, string? systemPath, string? systemVersion) cliInfo;
    private CliSourceMode _initialCliSource;
    private bool cliSourceChanged;

    [JSInvokable]
    public void JsUpdateSearch(string query)
    {
        searchQuery = query;
        InvokeAsync(StateHasChanged);
    }

    private async Task ClearSearch()
    {
        searchQuery = "";
        await JS.InvokeVoidAsync("eval", "document.getElementById('settings-search').value = ''");
    }

    private bool SectionVisible(string keywords)
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return true;
        var q = searchQuery.Trim().ToLowerInvariant();
        return keywords.ToLowerInvariant().Contains(q);
    }

    private bool GroupVisible(string groupKeyword)
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return true;
        var q = searchQuery.Trim().ToLowerInvariant();
        // Group visible if any keyword matches, or if group name matches
        if (groupKeyword.Contains(q)) return true;
        // Also check all section keywords within the group
        return groupKeyword switch
        {
            "connection" => SectionVisible("transport mode embedded persistent remote server port start stop pid devtunnel share tunnel mobile qr url token connect save reconnect"),
            "ui" => SectionVisible("chat message layout default reversed both left theme"),
            "developer" => SectionVisible("auto update main git watch relaunch rebuild"),
            _ => true
        };
    }

    private void ShowStatus(string message, string cls, int dismissMs = 3000)
    {
        _statusCts?.Cancel();
        statusMessage = message;
        statusClass = cls;
        StateHasChanged();
        if (dismissMs > 0)
        {
            _statusCts = new CancellationTokenSource();
            var token = _statusCts.Token;
            _ = Task.Delay(dismissMs, token).ContinueWith(_ =>
            {
                if (!token.IsCancellationRequested)
                    InvokeAsync(() => { statusMessage = null; StateHasChanged(); });
            }, TaskScheduler.Default);
        }
    }

    protected override void OnInitialized()
    {
        settings = ConnectionSettings.Load();
        _initialCliSource = settings.CliSource;
        DevTunnelService.OnStateChanged += OnTunnelStateChanged;
        GitAutoUpdate.OnStateChanged += OnAutoUpdateStateChanged;

        if (DevTunnelService.State == TunnelState.Running && DevTunnelService.TunnelUrl != null)
            GenerateQrCode(DevTunnelService.TunnelUrl, DevTunnelService.AccessToken);

        if (WsBridgeServer.IsRunning)
            GenerateDirectQrCode();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Fire and forget all slow initialization
            _ = InitializeAfterRenderAsync();
        }
    }

    private async Task InitializeAfterRenderAsync()
    {
        _selfRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("eval", "window.__setSettingsRef = function(ref) { window.__settingsRef = ref; };");
        await JS.InvokeVoidAsync("__setSettingsRef", _selfRef);
        await JS.InvokeVoidAsync("eval", @"
            (function() {
                var el = document.getElementById('settings-search');
                if (!el || el.__searchWired) return;
                el.__searchWired = true;
                var timer = null;
                el.addEventListener('input', function() {
                    clearTimeout(timer);
                    var val = el.value;
                    timer = setTimeout(function() {
                        if (window.__settingsRef) window.__settingsRef.invokeMethodAsync('JsUpdateSearch', val);
                    }, 150);
                });
            })()");

        // Run slow detection tasks in parallel (after first paint)
        var cliInfoTask = Task.Run(CopilotService.GetCliSourceInfo);
        var tasks = new List<Task>();
        tasks.Add(Task.Run(() => { serverAlive = ServerManager.CheckServerRunning("localhost", settings.Port); }));
        tasks.Add(Task.Run(() => { devTunnelAvailable = DevTunnelService.IsCliAvailable(); }));
        tasks.Add(Task.Run(() => { DiscoverLocalIps(); }));
        tasks.Add(TailscaleService.DetectAsync());
        await Task.WhenAll(tasks);
        cliInfo = await cliInfoTask;

        if (devTunnelAvailable)
            tunnelLoggedIn = await DevTunnelService.IsLoggedInAsync();

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        DevTunnelService.OnStateChanged -= OnTunnelStateChanged;
        GitAutoUpdate.OnStateChanged -= OnAutoUpdateStateChanged;
        _ = JS.InvokeVoidAsync("eval", "window.__settingsRef = null;");
        _selfRef?.Dispose();
    }

    private void OnTunnelStateChanged()
    {
        InvokeAsync(() =>
        {
            if (DevTunnelService.State == TunnelState.Running && DevTunnelService.TunnelUrl != null)
                GenerateQrCode(DevTunnelService.TunnelUrl, DevTunnelService.AccessToken);
            else
                qrCodeDataUri = null;
            StateHasChanged();
        });
    }

    private void GenerateQrCode(string url, string? token)
    {
        try
        {
            // Encode URL and token as JSON so the client gets everything from the QR code
            var payload = string.IsNullOrEmpty(token)
                ? url
                : System.Text.Json.JsonSerializer.Serialize(new { url, token });

            Console.WriteLine($"[QR] Generating QR code: url={url}, hasToken={!string.IsNullOrEmpty(token)}, payloadLen={payload.Length}");

            using var qrGenerator = new QRCoder.QRCodeGenerator();
            using var qrCodeData = qrGenerator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.L);
            using var qrCode = new QRCoder.PngByteQRCode(qrCodeData);
            var pngBytes = qrCode.GetGraphic(4, new byte[] { 0, 0, 0 }, new byte[] { 255, 255, 255 });
            qrCodeDataUri = $"data:image/png;base64,{Convert.ToBase64String(pngBytes)}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[QR] Error generating QR code: {ex.Message}");
        }
    }

    private MarkupString GetModeIcon(ConnectionMode mode) => mode switch
    {
        ConnectionMode.Embedded => new("<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"4\" y=\"4\" width=\"16\" height=\"16\" rx=\"2\" ry=\"2\"/><rect x=\"9\" y=\"9\" width=\"6\" height=\"6\"/><line x1=\"9\" y1=\"1\" x2=\"9\" y2=\"4\"/><line x1=\"15\" y1=\"1\" x2=\"15\" y2=\"4\"/><line x1=\"9\" y1=\"20\" x2=\"9\" y2=\"23\"/><line x1=\"15\" y1=\"20\" x2=\"15\" y2=\"23\"/><line x1=\"20\" y1=\"9\" x2=\"23\" y2=\"9\"/><line x1=\"20\" y1=\"14\" x2=\"23\" y2=\"14\"/><line x1=\"1\" y1=\"9\" x2=\"4\" y2=\"9\"/><line x1=\"1\" y1=\"14\" x2=\"4\" y2=\"14\"/></svg>"),
        ConnectionMode.Persistent => new("<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"2\" y=\"2\" width=\"20\" height=\"8\" rx=\"2\" ry=\"2\"/><rect x=\"2\" y=\"14\" width=\"20\" height=\"8\" rx=\"2\" ry=\"2\"/><line x1=\"6\" y1=\"6\" x2=\"6.01\" y2=\"6\"/><line x1=\"6\" y1=\"18\" x2=\"6.01\" y2=\"18\"/></svg>"),
        ConnectionMode.Remote => new("<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"/><path d=\"M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z\"/></svg>"),
        _ => new("<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/></svg>")
    };

    private string GetModeDescription(ConnectionMode mode) => mode switch
    {
        ConnectionMode.Embedded => "Copilot process dies when app closes.",
        ConnectionMode.Persistent => "Default. Copilot server survives app restarts. Sessions persist.",
        ConnectionMode.Remote => "Connect to a remote server via DevTunnel URL.",
        _ => ""
    };

    private string GetTunnelStatusText() => DevTunnelService.State switch
    {
        TunnelState.NotStarted => "Tunnel not started",
        TunnelState.Authenticating => "Authenticating with GitHub...",
        TunnelState.Starting => "Starting tunnel...",
        TunnelState.Running => $"Tunnel active: {DevTunnelService.TunnelUrl}",
        TunnelState.Stopping => "Stopping tunnel...",
        TunnelState.Error => $"Error: {DevTunnelService.ErrorMessage}",
        _ => "Unknown"
    };

    private void SetMode(ConnectionMode mode)
    {
        settings.Mode = mode;
    }

    private void SetCliSource(CliSourceMode source)
    {
        if (source == CliSourceMode.BuiltIn && cliInfo.builtInPath == null) return;
        if (source == CliSourceMode.System && cliInfo.systemPath == null) return;
        settings.CliSource = source;
        cliSourceChanged = source != _initialCliSource;
        settings.Save();
    }

    private static string ShortenPath(string path)
    {
        // Show just the last 2-3 segments for readability
        var parts = path.Split('/');
        return parts.Length > 3 ? "â€¦/" + string.Join("/", parts[^3..]) : path;
    }

    private async Task ScanQrCode()
    {
        var result = await QrScanner.ScanAsync();
        if (string.IsNullOrEmpty(result)) return;

        // QR code contains JSON { url, token } or a plain URL string
        string? url = null;
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(result);
            if (doc.RootElement.TryGetProperty("url", out var urlProp))
                url = urlProp.GetString();
            if (doc.RootElement.TryGetProperty("token", out var tokenProp))
                settings.RemoteToken = tokenProp.GetString();
        }
        catch
        {
            url = result;
        }

        if (!string.IsNullOrEmpty(url))
            settings.RemoteUrl = url;

        ShowStatus("QR code scanned!", "success");
    }

    private async Task TunnelLogin()
    {
        tunnelBusy = true;
        StateHasChanged();
        tunnelLoggedIn = await DevTunnelService.LoginAsync();
        tunnelBusy = false;
        StateHasChanged();
    }

    private async Task StartTunnel()
    {
        tunnelBusy = true;
        StateHasChanged();
        await DevTunnelService.HostAsync(settings.Port);
        if (DevTunnelService.State == TunnelState.Running)
        {
            settings.AutoStartTunnel = true;
            settings.Save();
        }
        tunnelBusy = false;
        StateHasChanged();
    }

    private void StopTunnel()
    {
        DevTunnelService.Stop();
        settings.AutoStartTunnel = false;
        settings.Save();
        qrCodeDataUri = null;
        StateHasChanged();
    }

    private async Task CopyTunnelUrl()
    {
        if (DevTunnelService.TunnelUrl != null)
        {
            await Microsoft.Maui.ApplicationModel.DataTransfer.Clipboard.SetTextAsync(DevTunnelService.TunnelUrl);
            ShowStatus("URL copied!", "success");
        }
    }

    private async Task CopyTunnelToken()
    {
        if (DevTunnelService.AccessToken != null)
        {
            await Microsoft.Maui.ApplicationModel.DataTransfer.Clipboard.SetTextAsync(DevTunnelService.AccessToken);
            ShowStatus("Token copied!", "success");
        }
    }

    private async Task StartServer()
    {
        starting = true;
        StateHasChanged();

        var success = await ServerManager.StartServerAsync(settings.Port);
        serverAlive = success;
        starting = false;

        ShowStatus(success ? $"Server started on port {settings.Port}" : "Failed to start server",
            success ? "success" : "error");
    }

    private void StopServer()
    {
        if (DevTunnelService.State == TunnelState.Running)
            DevTunnelService.Stop();
        ServerManager.StopServer();
        serverAlive = false;
        ShowStatus("Server stopped", "success");
    }

    private void SetChatLayout(ChatLayout layout)
    {
        settings.ChatLayout = layout;
        settings.Save();
        CopilotService.ChatLayout = layout;
        ShowStatus("Layout updated", "success");
    }

    private void ToggleAutoUpdate()
    {
        if (GitAutoUpdate.IsEnabled)
        {
            GitAutoUpdate.Stop();
            settings.AutoUpdateFromMain = false;
        }
        else
        {
            GitAutoUpdate.Start();
            settings.AutoUpdateFromMain = true;
        }
        settings.Save();
        StateHasChanged();
    }

    private void OnAutoUpdateStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetLayoutLabel(ChatLayout layout) => layout switch
    {
        ChatLayout.Default => "Default",
        ChatLayout.Reversed => "Reversed",
        ChatLayout.BothLeft => "Both left",
        _ => ""
    };

    private async Task SetTheme(UiTheme theme)
    {
        settings.Theme = theme;
        settings.Save();
        CopilotService.Theme = theme;
        await ApplyTheme(theme);
        ShowStatus("Theme updated", "success");
    }

    private async Task ApplyTheme(UiTheme theme)
    {
        var dataTheme = theme switch
        {
            UiTheme.System => "system",
            UiTheme.PolyPilotDark => "",        // default, no attribute needed
            UiTheme.PolyPilotLight => "polypilot-light",
            UiTheme.SolarizedDark => "solarized-dark",
            UiTheme.SolarizedLight => "solarized-light",
            _ => ""
        };
        await JS.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{dataTheme}')");
    }

    private string GetThemeLabel(UiTheme theme) => theme switch
    {
        UiTheme.System => "System",
        UiTheme.PolyPilotDark => "PolyPilot Dark",
        UiTheme.PolyPilotLight => "PolyPilot Light",
        UiTheme.SolarizedDark => "Solarized Dark",
        UiTheme.SolarizedLight => "Solarized Light",
        _ => ""
    };

    private string GetThemePreviewClass(UiTheme theme) => theme switch
    {
        UiTheme.System => "tp-system",
        UiTheme.PolyPilotDark => "tp-pp-dark",
        UiTheme.PolyPilotLight => "tp-pp-light",
        UiTheme.SolarizedDark => "tp-sol-dark",
        UiTheme.SolarizedLight => "tp-sol-light",
        _ => ""
    };

    private async Task SaveAndApply()
    {
        if (settings.Mode == ConnectionMode.Persistent && !serverAlive)
        {
            ShowStatus("Start the persistent server first", "error", 5000);
            return;
        }

        if (settings.Mode == ConnectionMode.Remote && string.IsNullOrWhiteSpace(settings.RemoteUrl))
        {
            ShowStatus("Enter a remote server URL", "error", 5000);
            return;
        }

        settings.Save();
        ShowStatus("Settings saved. Reconnecting...", "", 0);

        try
        {
            await CopilotService.ReconnectAsync(settings);
            ShowStatus("Connected!", "success");
            Nav.NavigateTo("/");
        }
        catch (Exception ex)
        {
            ShowStatus($"Connection failed: {ex.Message}", "error", 8000);
        }
    }

    // --- Direct Connection Sharing ---

    private void StartDirectSharing()
    {
        if (string.IsNullOrWhiteSpace(settings.ServerPassword)) return;
        WsBridgeServer.ServerPassword = settings.ServerPassword;
        WsBridgeServer.SetCopilotService(CopilotService);
        WsBridgeServer.Start(DevTunnelService.BridgePort, settings.Port);
        settings.DirectSharingEnabled = true;
        settings.Save();
        GenerateDirectQrCode();
        StateHasChanged();
    }

    private void StopDirectSharing()
    {
        WsBridgeServer.Stop();
        settings.DirectSharingEnabled = false;
        settings.Save();
        directQrCodeDataUri = null;
        StateHasChanged();
    }

    private async Task CopyDirectUrl()
    {
        var host = TailscaleService.MagicDnsName ?? TailscaleService.TailscaleIp ?? localIps.FirstOrDefault() ?? "localhost";
        var url = $"http://{host}:{DevTunnelService.BridgePort}";
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
        ShowStatus("URL copied!", "success", 2000);
    }

    private void DiscoverLocalIps()
    {
        localIps.Clear();
        try
        {
            foreach (var ni in System.Net.NetworkInformation.NetworkInterface.GetAllNetworkInterfaces())
            {
                if (ni.OperationalStatus != System.Net.NetworkInformation.OperationalStatus.Up) continue;
                if (ni.NetworkInterfaceType == System.Net.NetworkInformation.NetworkInterfaceType.Loopback) continue;
                foreach (var addr in ni.GetIPProperties().UnicastAddresses)
                {
                    if (addr.Address.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)
                        localIps.Add(addr.Address.ToString());
                }
            }
        }
        catch { }
    }

    private void GenerateDirectQrCode()
    {
        var host = TailscaleService.MagicDnsName ?? TailscaleService.TailscaleIp ?? localIps.FirstOrDefault();
        if (host == null) return;
        var url = $"http://{host}:{DevTunnelService.BridgePort}";
        var connectUrl = $"polypilot://connect?url={Uri.EscapeDataString(url)}&token={Uri.EscapeDataString(settings.ServerPassword ?? "")}";
        try
        {
            using var qr = new QRCoder.QRCodeGenerator();
            using var data = qr.CreateQrCode(connectUrl, QRCoder.QRCodeGenerator.ECCLevel.M);
            using var png = new QRCoder.PngByteQRCode(data);
            var bytes = png.GetGraphic(8, new byte[] { 255, 255, 255 }, new byte[] { 30, 30, 30 });
            directQrCodeDataUri = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
        }
        catch { }
    }
}
