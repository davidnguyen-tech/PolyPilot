@inherits LayoutComponentBase
@using PolyPilot.Services
@using PolyPilot.Models

<div class="page @(flyoutOpen ? "flyout-open" : "")">
    <div class="sidebar desktop-only">
        <SessionSidebar />
        <div class="sidebar-resize-handle" @onmousedown="StartResize"></div>
    </div>

    <div class="mobile-top-bar mobile-only">
        <SessionSidebar IsMobileTopBar="true" OnToggleFlyout="ToggleFlyout" FontSize="fontSize" OnFontSizeChange="HandleFontSizeChange" />
    </div>

    <main>
        <article class="content">
            @Body
        </article>
    </main>

    <div class="flyout-backdrop mobile-only @(flyoutOpen ? "open" : "")" @onclick="CloseFlyout"></div>
    <div class="flyout-panel mobile-only @(flyoutOpen ? "open" : "")">
        <SessionSidebar IsFlyoutPanel="true" OnToggleFlyout="CloseFlyout" OnSessionSelected="CloseFlyout" />
    </div>

    <PolyPilot.Components.Tutorial.TutorialOverlay />
</div>

@code {
    private bool flyoutOpen;
    private int fontSize = 20;

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private CopilotService CopilotService { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private TutorialService TutorialService { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var dataTheme = CopilotService.Theme switch
            {
                UiTheme.System => "system",
                UiTheme.PolyPilotLight => "polypilot-light",
                UiTheme.SolarizedDark => "solarized-dark",
                UiTheme.SolarizedLight => "solarized-light",
                _ => ""
            };
            await JS.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{dataTheme}')");

            // Load saved font size and navigate to last page
            var uiState = CopilotService.LoadUiState();
            if (uiState != null)
            {
                if (uiState.FontSize > 0)
                {
                    fontSize = uiState.FontSize;
                    await ApplyFontSize();
                }

                TutorialService.LoadCompleted(uiState.CompletedTutorials);
                
                // Navigate to the last page if not already there
                var currentUri = new Uri(NavManager.Uri);
                var currentPath = currentUri.LocalPath;
                if (currentPath == "/" && !string.IsNullOrEmpty(uiState.CurrentPage) && uiState.CurrentPage != "/" && uiState.CurrentPage != "/dashboard")
                {
                    NavManager.NavigateTo(uiState.CurrentPage);
                }
                
                StateHasChanged();
            }
        }
    }

    private async Task HandleFontSizeChange(int delta)
    {
        fontSize = Math.Clamp(fontSize + delta, 12, 24);
        await ApplyFontSize();
        CopilotService.SaveUiState("/", fontSize: fontSize);
    }

    private async Task ApplyFontSize()
    {
        await JS.InvokeVoidAsync("eval", $"document.documentElement.style.setProperty('--app-font-size', '{fontSize}px')");
    }

    private async Task StartResize(MouseEventArgs e)
    {
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                var sidebar = document.querySelector('.sidebar.desktop-only');
                if (!sidebar) return;
                var startX = {e.ClientX};
                var startW = sidebar.offsetWidth;
                function onMove(e) {{
                    var w = Math.min(Math.max(startW + e.clientX - startX, 200), 600);
                    sidebar.style.width = w + 'px';
                }}
                function onUp() {{
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }}
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'col-resize';
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }})();
        ");
    }

    private void ToggleFlyout()
    {
        flyoutOpen = !flyoutOpen;
    }

    private void CloseFlyout()
    {
        flyoutOpen = false;
    }
}
