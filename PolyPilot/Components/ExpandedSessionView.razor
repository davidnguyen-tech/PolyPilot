@using PolyPilot.Services
@using PolyPilot.Models
@using static PolyPilot.Components.Pages.Dashboard
@inject CopilotService CopilotService
@inject IJSRuntime JS

@{
    var isCompleted = IsCompleted;
    var cardClass = Session.IsProcessing ? "processing" : isCompleted ? "completed" : "idle";
}
<div class="expanded-card @cardClass" data-session="@Session.Name">
    <div class="chat-header">
        <h2 class="chat-header-title">@Session.Name</h2>
        <div class="chat-header-badges">
            @if (Session.IsProcessing)
            {
                <span class="processing-dot"></span>
            }
            <div class="info-popover">
                <span class="info-trigger">‚ÑπÔ∏é</span>
                <div class="info-panel">
                    <div class="info-row"><span class="info-label">Model</span><span class="info-value">@CurrentModel</span></div>
                    @if (!string.IsNullOrEmpty(Session.WorkingDirectory))
                    {
                        <div class="info-row"><span class="info-label">Directory</span><span class="info-value">@Session.WorkingDirectory</span></div>
                    }
                    @if (!string.IsNullOrEmpty(Session.GitBranch))
                    {
                        <div class="info-row"><span class="info-label">Branch</span><span class="info-value">@Session.GitBranch</span></div>
                    }
                    @if (UsageInfo?.PremiumQuota != null)
                    {
                        var q = UsageInfo.PremiumQuota;
                        <div class="info-row"><span class="info-label">Premium</span><span class="info-value">@(q.IsUnlimited ? "Unlimited" : $"{q.EntitlementRequests - q.UsedRequests}/{q.EntitlementRequests} remaining")</span></div>
                    }
                    @if (Session.SessionId != null && PlatformHelper.IsDesktop)
                    {
                        <button class="info-action" @onclick="() => OpenSessionFolder(Session.SessionId)" @onclick:stopPropagation="true">üìÇ Open session folder</button>
                    }
                </div>
            </div>
            <button class="icon-badge collapse-card-btn" data-tooltip="Back to grid (Esc / ‚åòE)" @onclick="OnCollapse">‚äü</button>
        </div>
    </div>

    <div class="messages expanded-messages">
        @{ var expandedMessages = GetWindowedMessages(); }
        @if (Session.History.Count > expandedMessages.Count)
        {
            <button class="load-more-btn" @onclick="LoadMore">
                ‚¨ÜÔ∏è Load more (@(Session.History.Count - expandedMessages.Count) remaining)
            </button>
        }
        <ChatMessageList Messages="expandedMessages"
                         StreamingContent="@StreamingContent"
                         CurrentToolName="@CurrentToolName"
                         ToolActivities="@ToolActivities"
                         ActivityText="@ActivityText"
                         IsProcessing="Session.IsProcessing"
                         Compact="false"
                         UserAvatarUrl="@UserAvatarUrl"
                         Layout="@Layout" />
    </div>

    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="error-bar">
            <span>‚ö†Ô∏è @Error</span>
            <button @onclick="OnDismissError">√ó</button>
        </div>
    }

    <div class="input-area">
        @if (!string.IsNullOrEmpty(Intent))
        {
            <div class="intent-pill">üí≠ @Intent</div>
        }
        @if (Session.MessageQueue.Any())
        {
            <div class="message-queue">
                <div class="queue-header">
                    <span>üìã Queued (@Session.MessageQueue.Count)</span>
                    <button class="queue-clear-btn" @onclick="OnClearQueue">Clear</button>
                </div>
                @for (var i = 0; i < Session.MessageQueue.Count; i++)
                {
                    var index = i;
                    var msg = Session.MessageQueue[i];
                    <div class="queue-item">
                        <span class="queue-index">@(index + 1)</span>
                        <span class="queue-text">@Truncate(msg, 80)</span>
                        <button class="queue-remove-btn" @onclick="() => OnRemoveQueuedMessage.InvokeAsync(index)">√ó</button>
                    </div>
                }
            </div>
        }
        @if (PendingImages != null && PendingImages.Any())
        {
            <div class="attachment-strip">
                @for (var pi = 0; pi < PendingImages.Count; pi++)
                {
                    var pidx = pi;
                    var pimg = PendingImages[pi];
                    <div class="attachment-thumb">
                        <img src="@pimg.DataUri" alt="@pimg.FileName" />
                        <button class="attachment-remove" @onclick="() => OnRemovePendingImage.InvokeAsync(pidx)" title="Remove">√ó</button>
                        <span class="attachment-name">@TruncateFileName(pimg.FileName, 15)</span>
                    </div>
                }
            </div>
        }
        <div class="input-row">
            <input type="file" id="file-@Session.Name.Replace(" ", "-")" accept="image/*" multiple style="display:none" />
            <textarea id="input-@Session.Name.Replace(" ", "-")"
                      placeholder="@(Session.IsProcessing ? "Message will be queued‚Ä¶" : PlatformHelper.IsMobile ? "Message..." : "Message... (‚Üµ send, ‚áß‚Üµ newline)")"
                      rows="1"></textarea>
            <button class="attach-btn" @onclick="() => OnAttach.InvokeAsync()" title="Attach image">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.49"/></svg>
            </button>
            @if (Session.IsProcessing)
            {
                <button class="send-btn stop-btn" @onclick="() => OnStop.InvokeAsync()" title="Stop">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                </button>
            }
            <button class="send-btn" @onclick="() => OnSend.InvokeAsync()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 4l14 8-14 8V4z"/></svg>
            </button>
        </div>
        <div class="input-status-bar">
            <div class="mode-switcher">
                <button class="mode-btn @(!PlanMode ? "active" : "")" @onclick="() => OnSetPlanMode.InvokeAsync(false)">Chat</button>
                <button class="mode-btn @(PlanMode ? "active" : "")" @onclick="() => OnSetPlanMode.InvokeAsync(true)">Plan</button>
            </div>
            <span class="status-sep">¬∑</span>
            <select class="inline-model-select" value="@CurrentModel" @onchange="e => OnSetModel.InvokeAsync(e.Value?.ToString())" disabled="@(Session.History.Count > 0)" title="@(Session.History.Count > 0 ? "Model cannot be changed during an active session" : "Select model")">
                @if (!AvailableModels.Contains(CurrentModel))
                {
                    <option value="@CurrentModel">@CurrentModel</option>
                }
                @foreach (var m in AvailableModels)
                {
                    <option value="@m">@m</option>
                }
            </select>
            <span class="status-extra">
                @if (UsageInfo != null)
                {
                    @if (UsageInfo.InputTokens.HasValue || UsageInfo.OutputTokens.HasValue)
                    {
                        <span class="status-sep">¬∑</span>
                        <span class="status-tokens">‚Üë@FormatTokenCount(UsageInfo.InputTokens ?? 0) ‚Üì@FormatTokenCount(UsageInfo.OutputTokens ?? 0)</span>
                    }
                    @if (UsageInfo.CurrentTokens.HasValue && UsageInfo.TokenLimit.HasValue)
                    {
                        <span class="status-sep">¬∑</span>
                        <span class="status-ctx">@FormatTokenCount(UsageInfo.CurrentTokens.Value)/@FormatTokenCount(UsageInfo.TokenLimit.Value) ctx</span>
                    }
                }
                <span class="status-sep">¬∑</span>
                <span class="status-msgs">@Session.History.Count msgs</span>
                <span class="status-sep">¬∑</span>
                <span class="font-size-controls">
                    <button class="font-size-btn" @onclick="() => OnFontSizeChange.InvokeAsync(-2)" disabled="@(FontSize <= 12)">A‚àí</button>
                    <span class="font-size-label" @onclick="() => OnFontSizeChange.InvokeAsync(0)">@(FontSize)px</span>
                    <button class="font-size-btn" @onclick="() => OnFontSizeChange.InvokeAsync(2)" disabled="@(FontSize >= 24)">A+</button>
                </span>
            </span>
            <span class="status-sep log-sep">¬∑</span>
            <span class="log-label" style="font-size:var(--type-footnote)">Log</span>
        </div>
    </div>
</div>

@code {
    [Parameter] public AgentSessionInfo Session { get; set; } = null!;
    [Parameter] public bool IsCompleted { get; set; }
    [Parameter] public string StreamingContent { get; set; } = "";
    [Parameter] public string ActivityText { get; set; } = "";
    [Parameter] public string CurrentToolName { get; set; } = "";
    [Parameter] public List<ToolActivity> ToolActivities { get; set; } = new();
    [Parameter] public string Intent { get; set; } = "";
    [Parameter] public string? Error { get; set; }
    [Parameter] public SessionUsageInfo? UsageInfo { get; set; }
    [Parameter] public bool PlanMode { get; set; }
    [Parameter] public string CurrentModel { get; set; } = "";
    [Parameter] public IReadOnlyList<string> AvailableModels { get; set; } = Array.Empty<string>();
    [Parameter] public List<PendingImage>? PendingImages { get; set; }
    [Parameter] public string? UserAvatarUrl { get; set; }
    [Parameter] public ChatLayout Layout { get; set; } = ChatLayout.Default;
    [Parameter] public int FontSize { get; set; } = 20;
    [Parameter] public int MessageWindowSize { get; set; } = 25;

    [Parameter] public EventCallback OnSend { get; set; }
    [Parameter] public EventCallback OnStop { get; set; }
    [Parameter] public EventCallback OnCollapse { get; set; }
    [Parameter] public EventCallback OnAttach { get; set; }
    [Parameter] public EventCallback OnDismissError { get; set; }
    [Parameter] public EventCallback OnClearQueue { get; set; }
    [Parameter] public EventCallback<int> OnRemoveQueuedMessage { get; set; }
    [Parameter] public EventCallback<int> OnRemovePendingImage { get; set; }
    [Parameter] public EventCallback<bool> OnSetPlanMode { get; set; }
    [Parameter] public EventCallback<string?> OnSetModel { get; set; }
    [Parameter] public EventCallback<int> OnFontSizeChange { get; set; }
    [Parameter] public EventCallback OnLoadMore { get; set; }

    private List<ChatMessage> GetWindowedMessages()
    {
        var history = Session.History;
        if (history.Count <= MessageWindowSize)
            return history;
        return history.Skip(history.Count - MessageWindowSize).ToList();
    }

    private void LoadMore() => OnLoadMore.InvokeAsync();

    private void OpenSessionFolder(string sessionId)
    {
        try
        {
            var path = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
                ".copilot", "session-state", sessionId);
            if (Directory.Exists(path))
                System.Diagnostics.Process.Start("open", path);
        }
        catch { }
    }

    private static string ShortenPath(string path)
    {
        var parts = path.Split(Path.DirectorySeparatorChar);
        if (parts.Length <= 2) return path;
        return "‚Ä¶/" + string.Join("/", parts[^2..]);
    }

    private static string FormatTokenCount(int count) =>
        count >= 1000 ? $"{count / 1000}k" : count.ToString();

    private static string Truncate(string s, int max) =>
        s.Length <= max ? s : s[..max] + "‚Ä¶";

    private static string TruncateFileName(string name, int maxLen) =>
        name.Length <= maxLen ? name : name[..maxLen] + "‚Ä¶";
}
