.chat-message-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}

.chat-empty {
    color: var(--text-muted);
    text-align: center;
    margin: auto;
    font-size: var(--type-body);
}

/* === Compact mode (dashboard cards) === */
.chat-message-list.compact ::deep .chat-msg {
    display: flex;
    gap: 0.5rem;
    font-size: var(--type-body);
    line-height: 1.4;
}

.chat-message-list.compact ::deep .chat-msg-role {
    font-weight: 600;
    flex-shrink: 0;
    font-size: var(--type-callout);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    align-self: flex-start;
}

.chat-message-list.compact ::deep .chat-msg.user .chat-msg-role {
    background: rgba(78, 168, 209, 0.3);
    color: #7fc4e8;
}

.chat-message-list.compact ::deep .chat-msg.assistant .chat-msg-role {
    background: rgba(0, 195, 91, 0.2);
    color: #00c35b;
}

.chat-message-list.compact ::deep .chat-msg-text {
    color: var(--text-primary);
    word-break: break-word;
}

.chat-message-list.compact ::deep .chat-msg-text.thinking {
    color: var(--text-muted);
    font-style: italic;
}

.chat-message-list.compact ::deep .thinking-label .dots span {
    animation: dotPulse 1.4s infinite ease-in-out;
    opacity: 0;
}
.chat-message-list.compact ::deep .thinking-label .dots span:nth-child(1) { animation-delay: 0s; }
.chat-message-list.compact ::deep .thinking-label .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-message-list.compact ::deep .thinking-label .dots span:nth-child(3) { animation-delay: 0.4s; }

/* === Full mode (chat page) === */
.chat-message-list.full ::deep .chat-msg {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
    max-width: 100%;
    padding: 0.75rem 1rem;
    align-items: flex-end;
}

.chat-message-list.full ::deep .chat-msg.user {
    justify-content: flex-end;
}

.chat-message-list.full ::deep .chat-msg.user .chat-msg-content {
    background: rgba(78, 168, 209, 0.2);
    border: 1px solid rgba(78, 168, 209, 0.3);
    border-radius: 12px 12px 0 12px;
    padding: 0.75rem 1rem 0.35rem;
    max-width: 80%;
}

::deep .chat-msg.user .chat-msg-text p {
    margin: 0 0 0.4rem;
}

::deep .chat-msg.user .chat-msg-text p:last-child {
    margin-bottom: 0;
}

.chat-message-list.full ::deep .chat-msg.assistant .chat-msg-content {
    background: rgba(0, 195, 91, 0.1);
    border: 1px solid rgba(0, 195, 91, 0.2);
    border-radius: 12px 12px 12px 0;
    padding: 0.75rem 1rem 0.35rem;
    max-width: 80%;
}

::deep .chat-msg.assistant .chat-msg-text p {
    margin: 0 0 0.4rem;
}

::deep .chat-msg.assistant .chat-msg-text p:last-child {
    margin-bottom: 0;
}

.chat-message-list.full ::deep .chat-msg-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.chat-message-list.full ::deep .chat-msg.user .chat-msg-avatar {
    order: 1;
    background: rgba(78, 168, 209, 0.3);
    width: 30px;
    height: 30px;
    overflow: hidden;
}

.chat-message-list.full ::deep .chat-msg.user .chat-msg-avatar .user-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.chat-message-list.full ::deep .chat-msg.assistant .chat-msg-avatar {
    background: transparent;
    overflow: hidden;
    width: 44px;
    height: 44px;
}

.chat-message-list.full ::deep .chat-msg.assistant .chat-msg-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.chat-message-list.full ::deep .chat-msg-text {
    color: var(--text-primary);
    word-break: break-word;
    line-height: 1.6;
}

.chat-message-list.full ::deep .chat-msg-text.thinking {
    color: var(--text-muted);
    font-style: italic;
}

.chat-message-list.full ::deep .thinking-label .dots span {
    animation: dotPulse 1.4s infinite ease-in-out;
    opacity: 0;
}
.chat-message-list.full ::deep .thinking-label .dots span:nth-child(1) { animation-delay: 0s; }
.chat-message-list.full ::deep .thinking-label .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-message-list.full ::deep .thinking-label .dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes dotPulse {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
}

.chat-message-list.full ::deep .chat-msg-time {
    font-size: var(--type-subhead);
    color: var(--text-muted);
    margin-top: 0.05rem;
}

.chat-message-list.full ::deep .chat-msg.system {
    justify-content: flex-start;
}

.chat-message-list.full ::deep .system-text {
    font-size: var(--type-body);
    color: var(--text-muted);
    font-style: italic;
    text-align: left;
    padding: 0.5rem;
}

.chat-message-list.full ::deep .chat-msg.shell-output {
    justify-content: flex-start;
    padding: 0 1rem;
}

.chat-message-list.full ::deep .shell-output-text {
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
    font-size: var(--type-footnote);
    color: var(--text-bright);
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    margin: 0;
    white-space: pre-wrap;
    word-break: break-all;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
}

/* Shared tool/reasoning styles for full mode */
::deep .reasoning-block {
    flex-shrink: 0;
    margin: 0.25rem 1rem;
    border-left: 2px solid rgba(168, 85, 247, 0.3);
    padding-left: 0.75rem;
}

::deep .reasoning-header {
    background: none;
    border: none;
    color: rgba(168, 85, 247, 0.7);
    font-size: var(--type-body);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
    width: 100%;
}

::deep .reasoning-content {
    font-size: var(--type-body);
    color: var(--text-muted);
    white-space: pre-wrap;
    line-height: 1.5;
    padding: 0.25rem 0;
}

::deep .reasoning-content.preview {
    max-height: 4.5em;
    overflow: hidden;
}

::deep .tool-card {
    flex-shrink: 0;
    margin: 0.25rem 1rem;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: var(--type-body);
    border: 1px solid var(--control-border);
    background: var(--bg-input);
}

::deep .tool-card.running { border-color: rgba(251, 191, 36, 0.3); }
::deep .tool-card.success { border-color: rgba(0, 195, 91, 0.3); }
::deep .tool-card.error { border-color: rgba(248, 113, 113, 0.3); }

::deep .tool-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

::deep .tool-info { color: var(--text-bright); display: flex; align-items: center; gap: 0.35rem; }
::deep .tool-status { display: flex; align-items: center; gap: 0.35rem; color: var(--text-muted); }

::deep .tool-result-section {
    margin-top: 0.5rem;
    border-top: 1px solid rgba(var(--accent-rgb, 78,168,209),0.06);
    padding-top: 0.5rem;
}

::deep .tool-result-content {
    font-size: var(--type-callout);
    color: var(--text-muted);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 300px;
    overflow-y: auto;
    margin: 0;
}

::deep .tool-result-toggle {
    background: none;
    border: none;
    color: rgba(78, 168, 209, 0.7);
    font-size: var(--type-callout);
    cursor: pointer;
    padding: 0;
}

::deep .tool-image-result img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 6px;
}

/* === Action Box (unified command + output container) === */
::deep .action-box {
    flex-shrink: 0;
    margin: 0.25rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--control-bg);
    border-radius: 8px;
    overflow: hidden;
}

::deep .action-box.running { border-color: rgba(251, 191, 36, 0.3); }
::deep .action-box.done { border-color: rgba(0, 195, 91, 0.2); }
::deep .action-box.failed { border-color: rgba(248, 113, 113, 0.3); }

::deep .action-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.6rem;
    font-size: var(--type-callout);
    border-bottom: 1px solid var(--control-bg);
}

::deep .action-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
}

::deep .action-box.running .action-dot {
    background: #f59e0b;
    box-shadow: 0 0 6px rgba(245,158,11,0.5);
    animation: pulse-dot 1.5s ease-in-out infinite;
}

::deep .action-box.done .action-dot { background: #22c55e; }
::deep .action-box.failed .action-dot { background: var(--accent-primary); }

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

::deep .action-label {
    font-weight: 600;
    color: var(--text-bright);
    white-space: nowrap;
}

/* Action-specific label colors */
::deep .action-edit .action-label { color: #f59e0b; }
::deep .action-create .action-label { color: #22c55e; }
::deep .action-read .action-label { color: var(--accent-primary); }
::deep .action-run .action-label { color: #a78bfa; }
::deep .action-search .action-label { color: var(--accent-primary); }
::deep .action-fetch .action-label { color: #34d399; }
::deep .action-query .action-label { color: #f472b6; }
::deep .action-agent .action-label { color: #c084fc; }
::deep .action-ask .action-label { color: #fbbf24; }
::deep .action-stop .action-label { color: var(--accent-primary); }
::deep .action-memory .action-label { color: #a78bfa; }
::deep .action-done .action-label { color: #22c55e; }

::deep .action-desc {
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
    font-size: var(--type-subhead);
}

::deep .action-input {
    padding: 0.5rem 0.6rem;
    background: rgba(0, 0, 0, 0.15);
}

::deep .action-input pre {
    font-size: var(--type-subhead);
    color: var(--text-primary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 200px;
    overflow-y: auto;
    margin: 0;
}

::deep .action-output-toggle {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.6rem;
    background: rgba(0, 0, 0, 0.1);
    border-top: 1px solid var(--control-bg);
    cursor: pointer;
    font-size: var(--type-subhead);
    color: var(--text-muted);
    transition: background 0.15s;
}

::deep .action-output-toggle:hover {
    background: rgba(0, 0, 0, 0.2);
}

::deep .action-output-toggle .toggle-icon {
    font-size: 0.65em;
    color: var(--text-muted);
}

::deep .action-output-toggle .toggle-label {
    color: var(--text-secondary);
    font-weight: 500;
}

::deep .action-output-toggle .output-hint {
    margin-left: auto;
    color: var(--text-muted);
    font-size: var(--type-footnote);
}

::deep .action-output {
    padding: 0.5rem 0.6rem;
    background: rgba(0, 0, 0, 0.15);
    border-top: 1px solid var(--control-bg);
}

::deep .action-output pre {
    font-size: var(--type-subhead);
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 250px;
    overflow-y: auto;
    margin: 0;
}

::deep .action-output img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 4px;
}

/* Legacy action-item styles kept for backwards compatibility */
::deep .action-item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.1rem 1rem;
    padding: 0.25rem 0.4rem;
    font-size: var(--type-callout);
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.15s;
}

::deep .action-item:hover {
    background: var(--hover-bg);
}

::deep .action-item.running .action-dot {
    background: #f59e0b;
    box-shadow: 0 0 6px rgba(245,158,11,0.5);
    animation: pulse-dot 1.5s ease-in-out infinite;
}

::deep .action-item.done .action-dot { background: #22c55e; }
::deep .action-item.failed .action-dot { background: var(--accent-primary); }

::deep .action-detail-hint {
    margin-left: auto;
    color: var(--text-muted);
    font-size: var(--type-footnote);
    white-space: nowrap;
    flex-shrink: 0;
}

::deep .action-expanded-input {
    margin: 0.15rem 1rem 0 2rem;
    padding: 0.4rem 0.6rem;
    background: var(--bg-input);
    border-radius: 6px 6px 0 0;
    border: 1px solid var(--control-bg);
    border-bottom: none;
}

::deep .action-expanded-input pre {
    font-size: var(--type-subhead);
    color: var(--text-primary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 150px;
    overflow-y: auto;
    margin: 0;
}

::deep .action-expanded-input + .action-expanded-result {
    margin-top: 0;
    border-radius: 0 0 6px 6px;
}

::deep .action-expanded-result {
    margin: 0.15rem 1rem 0.3rem 2rem;
    padding: 0.4rem 0.6rem;
    background: var(--bg-input);
    border-radius: 6px;
    border: 1px solid var(--control-bg);
    overflow: hidden;
}

::deep .action-expanded-result pre {
    font-size: var(--type-subhead);
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 200px;
    overflow-y: auto;
    margin: 0;
}

::deep .action-expanded-result img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 4px;
}

::deep .task-complete-card {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.25rem 1rem;
    padding: 0.75rem 1rem;
    background: rgba(0, 195, 91, 0.1);
    border: 1px solid rgba(0, 195, 91, 0.3);
    border-radius: 8px;
    color: #00c35b;
    font-size: var(--type-body);
}

::deep .error-card {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.25rem 1rem;
    padding: 0.5rem 0.75rem;
    background: rgba(248, 113, 113, 0.1);
    border: 1px solid rgba(248, 113, 113, 0.3);
    border-radius: 8px;
    color: #fca5a5;
    font-size: var(--type-body);
}

::deep .markdown-body {
    color: var(--text-primary);
}

::deep .markdown-body p:last-child {
    margin-bottom: 0;
}

::deep .markdown-body h1, ::deep .markdown-body h2, ::deep .markdown-body h3 {
    margin: 0.5em 0 0.25em;
    border: none;
    color: var(--text-primary);
}

::deep .markdown-body code {
    background: var(--control-border);
    padding: 0.15em 0.3em;
    border-radius: 3px;
    font-size: 0.85em;
}

::deep .markdown-body pre {
    background: var(--bg-tertiary);
    padding: 0.75rem;
    border-radius: 6px;
    overflow-x: auto;
}

::deep .markdown-body pre code {
    background: none;
    padding: 0;
}

::deep .markdown-body a { color: var(--accent-primary); }
::deep .markdown-body blockquote {
    border-left: 3px solid var(--hover-bg);
    margin: 0.5rem 0;
    padding: 0 0.75rem;
    color: var(--text-secondary);
}

::deep .markdown-body ul, ::deep .markdown-body ol {
    padding-left: 1.5rem;
    margin: 0.25rem 0;
}

::deep .markdown-body table {
    border-collapse: collapse;
    width: 100%;
}

::deep .markdown-body th, ::deep .markdown-body td {
    border: 1px solid var(--hover-bg);
    padding: 0.4rem 0.6rem;
    text-align: left;
}

@keyframes spin { to { transform: rotate(360deg); } }
::deep .spin { animation: spin 1s linear infinite; }

/* === User image attachments inline === */
::deep .user-image-attachment {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin: 0.2rem 0.3rem 0.2rem 0;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border-default);
    background: var(--bg-tertiary);
    padding: 0.2rem 0.5rem 0.2rem 0.25rem;
    vertical-align: middle;
    cursor: pointer;
}

::deep .user-image-attachment img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
}

::deep .user-image-name {
    font-size: var(--type-subhead);
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px;
}

/* === Mobile: tighter chat bubbles matching iOS chat conventions === */
@media (max-width: 640px) {
    .chat-message-list.full ::deep .chat-msg {
        padding: 0.4rem 0.5rem;
        gap: 0.35rem;
    }

    .chat-message-list.full ::deep .chat-msg-text {
        font-size: var(--type-callout);
        line-height: 1.45;
    }

    .chat-message-list.full ::deep .chat-msg.user .chat-msg-content,
    .chat-message-list.full ::deep .chat-msg.assistant .chat-msg-content {
        padding: 0.5rem 0.75rem;
        max-width: 85%;
    }

    .chat-message-list.full ::deep .chat-msg-time {
        font-size: var(--type-caption1);
    }

    .chat-message-list.full ::deep .chat-msg.user .chat-msg-avatar {
        width: 30px;
        height: 30px;
    }

    .chat-message-list.full ::deep .chat-msg.assistant .chat-msg-avatar {
        width: 40px;
        height: 40px;
    }

    .chat-message-list.full ::deep .system-text {
        font-size: var(--type-callout);
    }
}

/* Layout: Reversed â€” user left, assistant right */
.chat-message-list.full.layout-reversed ::deep .chat-msg.user {
    justify-content: flex-start;
}
.chat-message-list.full.layout-reversed ::deep .chat-msg.user .chat-msg-avatar {
    order: 0;
}
.chat-message-list.full.layout-reversed ::deep .chat-msg.user .chat-msg-content {
    border-radius: 12px 12px 12px 0;
}
.chat-message-list.full.layout-reversed ::deep .chat-msg.assistant {
    justify-content: flex-end;
}
.chat-message-list.full.layout-reversed ::deep .chat-msg.assistant .chat-msg-avatar {
    order: 1;
}
.chat-message-list.full.layout-reversed ::deep .chat-msg.assistant .chat-msg-content {
    border-radius: 12px 12px 0 12px;
}

/* Layout: Both left */
.chat-message-list.full.layout-both-left ::deep .chat-msg.user {
    justify-content: flex-start;
}
.chat-message-list.full.layout-both-left ::deep .chat-msg.user .chat-msg-avatar {
    order: 0;
}
.chat-message-list.full.layout-both-left ::deep .chat-msg.user .chat-msg-content {
    border-radius: 12px 12px 12px 0;
}
