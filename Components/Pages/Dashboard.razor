@page "/dashboard"
@using AutoPilot.App.Services
@using AutoPilot.App.Models
@inject CopilotService CopilotService
@inject IJSRuntime JS
@implements IDisposable

<div class="dashboard">
    <div class="dashboard-header">
        <h2><svg style="vertical-align:middle" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg> Session Orchestrator</h2>
        <span class="session-count">@sessions.Count active sessions</span>
    </div>

    @if (!sessions.Any())
    {
        <div class="no-sessions-dash">
            <p>No active sessions. Create sessions from the sidebar to orchestrate them here.</p>
        </div>
    }
    else
    {
        <div class="session-grid">
            @foreach (var session in sessions)
            {
                var isCompleted = completedSessions.Contains(session.Name);
                var cardClass = session.IsProcessing ? "processing" : isCompleted ? "completed" : "idle";
                <div class="session-card @cardClass">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-status-dot @cardClass"></span>
                            <h3>@session.Name</h3>
                        </div>
                        <span class="card-model">@session.Model</span>
                        <button class="card-close" @onclick="() => CloseSession(session.Name)" title="Close session">✕</button>
                    </div>

                    <div class="card-messages">
                        @{
                            var lastMessages = session.History.TakeLast(6).ToList();
                        }
                        @if (!lastMessages.Any())
                        {
                            <p class="card-empty">No messages yet</p>
                        }
                        else
                        {
                            @foreach (var msg in lastMessages)
                            {
                                @switch (msg.MessageType)
                                {
                                    case ChatMessageType.User:
                                        <div class="card-msg user">
                                            <span class="card-msg-role">You</span>
                                            <span class="card-msg-text">@Truncate(msg.Content, 120)</span>
                                        </div>
                                        break;
                                    case ChatMessageType.Assistant:
                                        <div class="card-msg assistant">
                                            <span class="card-msg-role">AI</span>
                                            <span class="card-msg-text">@Truncate(msg.Content, 120)</span>
                                        </div>
                                        break;
                                    case ChatMessageType.ToolCall:
                                        <div class="card-msg tool">
                                            <span class="card-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>
                                            <span class="card-msg-text">@(msg.ToolName ?? "tool") @(msg.IsComplete ? (msg.IsSuccess ? "✓" : "✗") : "…")</span>
                                        </div>
                                        break;
                                    case ChatMessageType.Reasoning:
                                        <div class="card-msg reasoning">
                                            <span class="card-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.4V20a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.6c2.9-1.1 5-4 5-7.4a8 8 0 0 0-8-8z"/><line x1="10" y1="22" x2="14" y2="22"/></svg></span>
                                            <span class="card-msg-text">@(msg.IsComplete ? "Thought" : "Thinking...")</span>
                                        </div>
                                        break;
                                    case ChatMessageType.Error:
                                        <div class="card-msg error">
                                            <span class="card-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
                                            <span class="card-msg-text">@Truncate(msg.Content, 80)</span>
                                        </div>
                                        break;
                                }
                            }
                        }
                        @if (session.IsProcessing)
                        {
                            @if (streamingBySession.TryGetValue(session.Name, out var streaming) && !string.IsNullOrEmpty(streaming))
                            {
                                <div class="card-msg assistant">
                                    <span class="card-msg-role">AI</span>
                                    <span class="card-msg-text">@streaming</span>
                                </div>
                            }
                            <div class="card-msg assistant">
                                <span class="card-msg-role">AI</span>
                                <span class="card-msg-text thinking">@(activityBySession.TryGetValue(session.Name, out var act) && !string.IsNullOrEmpty(act) ? act : "Thinking...")</span>
                            </div>
                        }
                    </div>

                    <div class="card-input">
                        <input type="text" id="input-@session.Name.Replace(" ", "-")"
                               placeholder="Send to @session.Name..."
                               disabled="@session.IsProcessing" />
                        <button @onclick="() => SendFromCard(session.Name)"
                                disabled="@session.IsProcessing">
                            @(session.IsProcessing ? "…" : "➤")
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="broadcast-section">
            <h3><svg style="vertical-align:middle" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 8.5L9 12l-3.5 3.5"/><path d="M2 12h7"/><path d="M14 4.5A7.5 7.5 0 0 1 14 19.5"/><path d="M17.5 2a11 11 0 0 1 0 20"/></svg> Broadcast to All</h3>
            <div class="broadcast-input">
                <input type="text" id="broadcastInput"
                       placeholder="Send same message to all sessions..." />
                <button @onclick="BroadcastMessage">Send to All</button>
            </div>
        </div>
    }
</div>

@code {
    private List<AgentSessionInfo> sessions = new();
    private HashSet<string> completedSessions = new();
    private Dictionary<string, string> streamingBySession = new();
    private Dictionary<string, string> activityBySession = new();

    protected override void OnInitialized()
    {
        CopilotService.OnStateChanged += RefreshState;
        CopilotService.OnSessionComplete += HandleComplete;
        CopilotService.OnContentReceived += HandleContent;
        CopilotService.OnActivity += HandleActivity;
        RefreshState();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up Enter key handlers for all card inputs
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.closest('.card-input input')) {
                        e.preventDefault();
                        e.target.closest('.card-input').querySelector('button')?.click();
                    }
                    if (e.key === 'Enter' && e.target.id === 'broadcastInput') {
                        e.preventDefault();
                        document.querySelector('.broadcast-input button')?.click();
                    }
                });
            ");
        }

        // Auto-scroll all card message containers to bottom
        await JS.InvokeVoidAsync("eval", @"
            document.querySelectorAll('.card-messages').forEach(el => el.scrollTop = el.scrollHeight);
        ");
    }

    private void RefreshState()
    {
        sessions = CopilotService.GetAllSessions().ToList();
        InvokeAsync(StateHasChanged);
    }

    private void HandleComplete(string sessionName, string summary)
    {
        completedSessions.Add(sessionName);
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);
        InvokeAsync(StateHasChanged);
        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            completedSessions.Remove(sessionName);
            InvokeAsync(StateHasChanged);
        });
    }

    private void HandleContent(string sessionName, string content)
    {
        if (!streamingBySession.ContainsKey(sessionName))
            streamingBySession[sessionName] = "";
        streamingBySession[sessionName] += content;
        InvokeAsync(StateHasChanged);
    }

    private void HandleActivity(string sessionName, string activity)
    {
        activityBySession[sessionName] = activity;
        InvokeAsync(StateHasChanged);
    }

    private async Task SendFromCard(string sessionName)
    {
        var inputId = $"input-{sessionName.Replace(" ", "-")}";
        var prompt = await JS.InvokeAsync<string>("eval", $"document.getElementById('{inputId}')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", $"document.getElementById('{inputId}').value = ''");
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);

        try
        {
            _ = CopilotService.SendPromptAsync(sessionName, prompt.Trim());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending to {sessionName}: {ex.Message}");
        }
    }

    private async Task BroadcastMessage()
    {
        var prompt = await JS.InvokeAsync<string>("eval", "document.getElementById('broadcastInput')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", "document.getElementById('broadcastInput').value = ''");

        foreach (var session in sessions.Where(s => !s.IsProcessing))
        {
            try
            {
                _ = CopilotService.SendPromptAsync(session.Name, prompt.Trim());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error broadcasting to {session.Name}: {ex.Message}");
            }
        }
    }

    private async Task CloseSession(string sessionName)
    {
        await CopilotService.CloseSessionAsync(sessionName);
    }

    private string Truncate(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        text = text.Replace("\n", " ").Replace("\r", "");
        return text.Length > maxLength ? text[..maxLength] + "..." : text;
    }

    public void Dispose()
    {
        CopilotService.OnStateChanged -= RefreshState;
        CopilotService.OnSessionComplete -= HandleComplete;
        CopilotService.OnContentReceived -= HandleContent;
        CopilotService.OnActivity -= HandleActivity;
    }
}
