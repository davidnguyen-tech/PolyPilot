@page "/dashboard"
@using AutoPilot.App.Services
@using AutoPilot.App.Models
@inject CopilotService CopilotService
@inject IJSRuntime JS
@inject NavigationManager Nav
@implements IDisposable

<div class="dashboard">
    <div class="dashboard-header">
        <h2><svg style="vertical-align:middle" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg> Session Orchestrator</h2>
        <span class="session-count">@sessions.Count active sessions</span>
    </div>

    @if (!sessions.Any())
    {
        <div class="no-sessions-dash">
            <p>No active sessions. Create sessions from the sidebar to orchestrate them here.</p>
        </div>
    }
    else
    {
        <div class="session-grid">
            @foreach (var session in sessions)
            {
                var isCompleted = completedSessions.Contains(session.Name);
                var cardClass = session.IsProcessing ? "processing" : isCompleted ? "completed" : "idle";
                <div class="session-card @cardClass">
                    <div class="card-header">
                        <div class="card-title" @onclick="() => GoToSession(session.Name)" style="cursor:pointer">
                            <span class="card-status-dot @cardClass"></span>
                            <h3>@session.Name</h3>
                        </div>
                        <span class="card-model">@session.Model</span>
                        <button class="card-close" @onclick="() => CloseSession(session.Name)" title="Close session">✕</button>
                    </div>


                    <div class="card-messages">
                        @{
                            List<ChatMessage> lastMessages;
                            try { lastMessages = session.History.TakeLast(6).ToList(); }
                            catch { lastMessages = new(); }
                        }
                        <ChatMessageList Messages="lastMessages"
                                         StreamingContent="@(streamingBySession.TryGetValue(session.Name, out var s) ? s : "")"
                                         ActivityText="@(activityBySession.TryGetValue(session.Name, out var a) ? a : "")"
                                         IsProcessing="session.IsProcessing"
                                         Compact="true" />
                    </div>

                    <div class="card-input">
                        <input type="text" id="input-@session.Name.Replace(" ", "-")"
                               placeholder="Send to @session.Name..."
                               disabled="@session.IsProcessing" />
                        <button @onclick="() => SendFromCard(session.Name)"
                                disabled="@session.IsProcessing">
                            @(session.IsProcessing ? "…" : "➤")
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="broadcast-section">
            <h3><svg style="vertical-align:middle" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 8.5L9 12l-3.5 3.5"/><path d="M2 12h7"/><path d="M14 4.5A7.5 7.5 0 0 1 14 19.5"/><path d="M17.5 2a11 11 0 0 1 0 20"/></svg> Broadcast to All</h3>
            <div class="broadcast-input">
                <input type="text" id="broadcastInput"
                       placeholder="Send same message to all sessions..." />
                <button @onclick="BroadcastMessage">Send to All</button>
            </div>
        </div>
    }
</div>

@code {
    private List<AgentSessionInfo> sessions = new();
    private HashSet<string> completedSessions = new();
    private Dictionary<string, string> streamingBySession = new();
    private Dictionary<string, string> activityBySession = new();

    protected override void OnInitialized()
    {
        CopilotService.OnStateChanged += RefreshState;
        CopilotService.OnSessionComplete += HandleComplete;
        CopilotService.OnContentReceived += HandleContent;
        CopilotService.OnActivity += HandleActivity;
        RefreshState();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up Enter and Tab key handlers for card inputs
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    var isCardInput = e.target.matches && e.target.matches('.card-input input');
                    var isBroadcast = e.target.id === 'broadcastInput';
                    if (e.key === 'Enter' && isCardInput) {
                        e.preventDefault();
                        e.target.closest('.card-input').querySelector('button')?.click();
                    }
                    if (e.key === 'Enter' && isBroadcast) {
                        e.preventDefault();
                        document.querySelector('.broadcast-input button')?.click();
                    }
                    // Tab / Shift+Tab to cycle between card inputs only when focused on one
                    if (e.key === 'Tab' && (isCardInput || isBroadcast)) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        var inputs = Array.from(document.querySelectorAll('.card-input input:not(:disabled), #broadcastInput'));
                        if (inputs.length < 2) return;
                        var idx = inputs.indexOf(e.target);
                        if (idx < 0) idx = 0;
                        idx = e.shiftKey ? (idx - 1 + inputs.length) % inputs.length : (idx + 1) % inputs.length;
                        inputs[idx].focus();
                    }
                });
            ");
        }

        // Auto-scroll all card message containers to bottom
        await JS.InvokeVoidAsync("eval", @"
            document.querySelectorAll('.card-messages').forEach(el => el.scrollTop = el.scrollHeight);
        ");
    }

    private void RefreshState()
    {
        sessions = CopilotService.GetAllSessions().ToList();
        InvokeAsync(StateHasChanged);
    }

    private void HandleComplete(string sessionName, string summary)
    {
        completedSessions.Add(sessionName);
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);
        InvokeAsync(StateHasChanged);
        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            completedSessions.Remove(sessionName);
            InvokeAsync(StateHasChanged);
        });
    }

    private void HandleContent(string sessionName, string content)
    {
        if (!streamingBySession.ContainsKey(sessionName))
            streamingBySession[sessionName] = "";
        streamingBySession[sessionName] += content;
        InvokeAsync(StateHasChanged);
    }

    private void HandleActivity(string sessionName, string activity)
    {
        activityBySession[sessionName] = activity;
        InvokeAsync(StateHasChanged);
    }

    private async Task SendFromCard(string sessionName)
    {
        var inputId = $"input-{sessionName.Replace(" ", "-")}";
        var prompt = await JS.InvokeAsync<string>("eval", $"document.getElementById('{inputId}')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", $"document.getElementById('{inputId}').value = ''");
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);

        try
        {
            _ = CopilotService.SendPromptAsync(sessionName, prompt.Trim()).ContinueWith(t =>
            {
                if (t.IsFaulted)
                {
                    InvokeAsync(() =>
                    {
                        Console.WriteLine($"Error sending to {sessionName}: {t.Exception?.InnerException?.Message}");
                    });
                }
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending to {sessionName}: {ex.Message}");
        }
    }

    private async Task BroadcastMessage()
    {
        var prompt = await JS.InvokeAsync<string>("eval", "document.getElementById('broadcastInput')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", "document.getElementById('broadcastInput').value = ''");

        foreach (var session in sessions.Where(s => !s.IsProcessing))
        {
            try
            {
                _ = CopilotService.SendPromptAsync(session.Name, prompt.Trim());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error broadcasting to {session.Name}: {ex.Message}");
            }
        }
    }

    private async Task CloseSession(string sessionName)
    {
        await CopilotService.CloseSessionAsync(sessionName);
    }

    private void GoToSession(string sessionName)
    {
        CopilotService.SwitchSession(sessionName);
        CopilotService.SaveUiState("/", sessionName);
        Nav.NavigateTo("/");
    }

    public void Dispose()
    {
        CopilotService.OnStateChanged -= RefreshState;
        CopilotService.OnSessionComplete -= HandleComplete;
        CopilotService.OnContentReceived -= HandleContent;
        CopilotService.OnActivity -= HandleActivity;
    }
}
