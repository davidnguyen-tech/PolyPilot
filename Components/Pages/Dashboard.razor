@page "/dashboard"
@using AutoPilot.App.Services
@using AutoPilot.App.Models
@inject CopilotService CopilotService
@inject IJSRuntime JS
@implements IDisposable

<div class="dashboard">
    <div class="dashboard-header">
        <h2>üéõÔ∏è Session Orchestrator</h2>
        <span class="session-count">@sessions.Count active sessions</span>
    </div>

    @if (!sessions.Any())
    {
        <div class="no-sessions-dash">
            <p>No active sessions. Create sessions from the sidebar to orchestrate them here.</p>
        </div>
    }
    else
    {
        <div class="session-grid">
            @foreach (var session in sessions)
            {
                var isCompleted = completedSessions.Contains(session.Name);
                var cardClass = session.IsProcessing ? "processing" : isCompleted ? "completed" : "idle";
                <div class="session-card @cardClass">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-status-dot @cardClass"></span>
                            <h3>@session.Name</h3>
                        </div>
                        <button class="card-close" @onclick="() => CloseSession(session.Name)" title="Close session">‚úï</button>
                        <span class="card-model">@session.Model</span>
                    </div>

                    <div class="card-messages">
                        @{
                            var lastMessages = session.History.TakeLast(6).ToList();
                        }
                        @if (!lastMessages.Any())
                        {
                            <p class="card-empty">No messages yet</p>
                        }
                        else
                        {
                            @foreach (var msg in lastMessages)
                            {
                                <div class="card-msg @(msg.IsUser ? "user" : "assistant")">
                                    <span class="card-msg-role">@(msg.IsUser ? "You" : "AI")</span>
                                    <span class="card-msg-text">@msg.Content</span>
                                </div>
                            }
                        }
                        @if (session.IsProcessing)
                        {
                            @if (streamingBySession.TryGetValue(session.Name, out var streaming) && !string.IsNullOrEmpty(streaming))
                            {
                                <div class="card-msg assistant">
                                    <span class="card-msg-role">AI</span>
                                    <span class="card-msg-text">@streaming</span>
                                </div>
                            }
                            <div class="card-msg assistant">
                                <span class="card-msg-role">AI</span>
                                <span class="card-msg-text thinking">@(activityBySession.TryGetValue(session.Name, out var act) && !string.IsNullOrEmpty(act) ? act : "Thinking...")</span>
                            </div>
                        }
                    </div>

                    <div class="card-input">
                        <input type="text" id="input-@session.Name.Replace(" ", "-")"
                               placeholder="Send to @session.Name..."
                               disabled="@session.IsProcessing" />
                        <button @onclick="() => SendFromCard(session.Name)"
                                disabled="@session.IsProcessing">
                            @(session.IsProcessing ? "‚è≥" : "‚û§")
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="broadcast-section">
            <h3>üì¢ Broadcast to All</h3>
            <div class="broadcast-input">
                <input type="text" id="broadcastInput"
                       placeholder="Send same message to all sessions..." />
                <button @onclick="BroadcastMessage">Send to All</button>
            </div>
        </div>
    }
</div>

@code {
    private List<AgentSessionInfo> sessions = new();
    private HashSet<string> completedSessions = new();
    private Dictionary<string, string> streamingBySession = new();
    private Dictionary<string, string> activityBySession = new();

    protected override void OnInitialized()
    {
        CopilotService.OnStateChanged += RefreshState;
        CopilotService.OnSessionComplete += HandleComplete;
        CopilotService.OnContentReceived += HandleContent;
        CopilotService.OnActivity += HandleActivity;
        RefreshState();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up Enter key handlers for all card inputs
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.closest('.card-input input')) {
                        e.preventDefault();
                        e.target.closest('.card-input').querySelector('button')?.click();
                    }
                    if (e.key === 'Enter' && e.target.id === 'broadcastInput') {
                        e.preventDefault();
                        document.querySelector('.broadcast-input button')?.click();
                    }
                });
            ");
        }

        // Auto-scroll all card message containers to bottom
        await JS.InvokeVoidAsync("eval", @"
            document.querySelectorAll('.card-messages').forEach(el => el.scrollTop = el.scrollHeight);
        ");
    }

    private void RefreshState()
    {
        sessions = CopilotService.GetAllSessions().ToList();
        InvokeAsync(StateHasChanged);
    }

    private void HandleComplete(string sessionName, string summary)
    {
        completedSessions.Add(sessionName);
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);
        InvokeAsync(StateHasChanged);
        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            completedSessions.Remove(sessionName);
            InvokeAsync(StateHasChanged);
        });
    }

    private void HandleContent(string sessionName, string content)
    {
        if (!streamingBySession.ContainsKey(sessionName))
            streamingBySession[sessionName] = "";
        streamingBySession[sessionName] += content;
        InvokeAsync(StateHasChanged);
    }

    private void HandleActivity(string sessionName, string activity)
    {
        activityBySession[sessionName] = activity;
        InvokeAsync(StateHasChanged);
    }

    private async Task SendFromCard(string sessionName)
    {
        var inputId = $"input-{sessionName.Replace(" ", "-")}";
        var prompt = await JS.InvokeAsync<string>("eval", $"document.getElementById('{inputId}')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", $"document.getElementById('{inputId}').value = ''");
        streamingBySession.Remove(sessionName);
        activityBySession.Remove(sessionName);

        try
        {
            _ = CopilotService.SendPromptAsync(sessionName, prompt.Trim());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending to {sessionName}: {ex.Message}");
        }
    }

    private async Task BroadcastMessage()
    {
        var prompt = await JS.InvokeAsync<string>("eval", "document.getElementById('broadcastInput')?.value || ''");
        if (string.IsNullOrWhiteSpace(prompt)) return;

        await JS.InvokeVoidAsync("eval", "document.getElementById('broadcastInput').value = ''");

        foreach (var session in sessions.Where(s => !s.IsProcessing))
        {
            try
            {
                _ = CopilotService.SendPromptAsync(session.Name, prompt.Trim());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error broadcasting to {session.Name}: {ex.Message}");
            }
        }
    }

    private async Task CloseSession(string sessionName)
    {
        await CopilotService.CloseSessionAsync(sessionName);
    }

    private string Truncate(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        text = text.Replace("\n", " ").Replace("\r", "");
        return text.Length > maxLength ? text[..maxLength] + "..." : text;
    }

    public void Dispose()
    {
        CopilotService.OnStateChanged -= RefreshState;
        CopilotService.OnSessionComplete -= HandleComplete;
        CopilotService.OnContentReceived -= HandleContent;
        CopilotService.OnActivity -= HandleActivity;
    }
}
