@using AutoPilot.App.Services
@using AutoPilot.App.Models
@inject CopilotService CopilotService
@inject IJSRuntime JS
@inject NavigationManager Nav

@if (IsMobileTopBar)
{
    <div class="mobile-bar">
        <button class="hamburger-btn" @onclick="ToggleFlyout">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <span class="mobile-title"><svg style="vertical-align:middle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="2" y="8" width="20" height="8" rx="2"/><path d="M6 16v4"/><path d="M18 16v4"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg> AutoPilot</span>
        <div class="mobile-tabs">
            <a href="/" class="mobile-tab @(currentPage == "/" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/"); currentPage = "/"; }'>Chat</a>
            <a href="/dashboard" class="mobile-tab @(currentPage == "/dashboard" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/dashboard"); currentPage = "/dashboard"; }'>Dashboard</a>
            <a href="/settings" class="mobile-tab @(currentPage == "/settings" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/settings"); currentPage = "/settings"; }'><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></a>
        </div>
    </div>
}
else if (IsFlyoutPanel)
{
    <div class="sidebar-content flyout-content">
        <div class="flyout-header">
            <h3>Sessions</h3>
            <button class="flyout-close-btn" @onclick="ToggleFlyout">✕</button>
        </div>

        <div class="new-session">
            <input type="text" id="flyoutSessionNameInput" placeholder="Session name..." />
            <div class="session-options-row">
                <select @bind="selectedModel" class="model-select">
                    @foreach (var model in availableModels)
                    {
                        <option value="@model">@model</option>
                    }
                </select>
                <button class="dir-toggle-btn" @onclick="ToggleDirectoryInput" title="Set working directory"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></button>
                <button @onclick="CreateSession" disabled="@isCreating">
                    @(isCreating ? "..." : "+")
                </button>
            </div>
            @if (showDirectoryInput)
            {
                <div class="dir-input-row">
                    <input type="text" id="flyoutSessionDirInput"
                           placeholder="Working directory (default: AutoPilot.App)" 
                           class="dir-input" />
                    <button class="dir-browse-btn" @onclick="BrowseDirectory" title="Browse folders"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></button>
                </div>
            }
            @if (createError != null)
            {
                <div style="color:#ff6b6b;font-size:0.75rem;padding:2px 4px;">⚠ @createError</div>
            }
        </div>

        <div class="sidebar-divider"></div>

        @RenderSessionList
    </div>
}
else
{
    <div class="sidebar-content">
        <div class="sidebar-header">
            <h3><svg style="vertical-align:middle" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="2" y="8" width="20" height="8" rx="2"/><path d="M6 16v4"/><path d="M18 16v4"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg> AutoPilot</h3>
            <p class="status @(CopilotService.IsInitialized ? "connected" : "disconnected")">
                @if (CopilotService.IsInitialized)
                {
                    <text>● @CopilotService.CurrentMode</text>
                }
                else
                {
                    <text>○ Disconnected</text>
                }
            </p>
            <div class="nav-tabs">
                <a href="/" class="nav-tab @(currentPage == "/" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/"); currentPage = "/"; }'><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Chat</a>
                <a href="/dashboard" class="nav-tab @(currentPage == "/dashboard" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/dashboard"); currentPage = "/dashboard"; }'><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg> Dashboard</a>
                <a href="/settings" class="nav-tab @(currentPage == "/settings" ? "active" : "")" @onclick='() => { CopilotService.SaveUiState("/settings"); currentPage = "/settings"; }'><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></a>
            </div>
        </div>

        <div class="new-session">
            <input type="text" id="sessionNameInput" placeholder="Session name..." />
            <div class="session-options-row">
                <select @bind="selectedModel" class="model-select">
                    @foreach (var model in availableModels)
                    {
                        <option value="@model">@model</option>
                    }
                </select>
                <button class="dir-toggle-btn" @onclick="ToggleDirectoryInput" title="Set working directory"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></button>
                <button @onclick="CreateSession" disabled="@isCreating">
                    @(isCreating ? "..." : "+")
                </button>
            </div>
            @if (showDirectoryInput)
            {
                <div class="dir-input-row">
                    <input type="text" id="sessionDirInput"
                           placeholder="Working directory (default: AutoPilot.App)" 
                           class="dir-input" />
                    <button class="dir-browse-btn" @onclick="BrowseDirectory" title="Browse folders"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2-2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></button>
                </div>
            }
            @if (createError != null)
            {
                <div style="color:#ff6b6b;font-size:0.75rem;padding:2px 4px;">⚠ @createError</div>
            }
        </div>

        <div class="sidebar-divider"></div>

        @RenderSessionList
    </div>
}

@code {
    [Parameter] public bool IsMobileTopBar { get; set; }
    [Parameter] public bool IsFlyoutPanel { get; set; }
    [Parameter] public EventCallback OnToggleFlyout { get; set; }
    [Parameter] public EventCallback OnSessionSelected { get; set; }

    private RenderFragment RenderSessionList => __builder =>
    {
        <div class="session-list">
            <div class="section-header"><span class="section-header-label"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Active Sessions</span></div>
            @if (!sessions.Any())
            {
                <p class="no-sessions">No active sessions.<br/>Create one above or resume below.</p>
            }
            else
            {
                var sessionIndex = 0;
                @foreach (var session in sessions)
                {
                    sessionIndex++;
                    var idx = sessionIndex;
                    var cssClass = session.Name == CopilotService.ActiveSessionName ? "active" : 
                                   completedSessions.Contains(session.Name) ? "completed" :
                                   session.IsProcessing ? "busy" : "";
                    <div class="session-item @cssClass"
                         @onclick="() => SelectSession(session.Name)">
                        <div class="session-info">
                            <span class="session-name">
                                @if (idx <= 9)
                                {
                                    <span class="shortcut-badge" title="⌘@idx">@idx</span>
                                }
                                @if (completedSessions.Contains(session.Name))
                                {
                                    <span class="done-badge"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></span>
                                }
                                @if (renamingSession == session.Name)
                                {
                                    <input type="text" class="rename-input" id="renameInput"
                                           value="@session.Name"
                                           @onclick:stopPropagation="true"
                                           @onblur="CommitRename"
                                           @onkeydown="HandleRenameKeyDown" />
                                }
                                else
                                {
                                    <span @ondblclick="() => StartRename(session.Name)" @ondblclick:stopPropagation="true">@session.Name</span>
                                }
                                @if (session.IsResumed)
                                {
                                    <span class="resumed-badge">resumed</span>
                                }
                            </span>
                            <span class="session-meta">
                                @session.MessageCount msgs • @session.Model
                                @if (!string.IsNullOrEmpty(session.WorkingDirectory))
                                {
                                    <text> • @GetShortPath(session.WorkingDirectory)</text>
                                }
                            </span>
                        </div>
                        <div class="session-actions">
                            @if (session.IsProcessing)
                            {
                                <span class="processing">●</span>
                            }
                            <button class="rename-btn" @onclick:stopPropagation="true"
                                    @onclick="() => StartRename(session.Name)" title="Rename session"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="close-btn" @onclick:stopPropagation="true" 
                                    @onclick="() => CloseSession(session.Name)">×</button>
                        </div>
                    </div>
                }
            }

            @if (persistedSessions.Any())
            {
                <div class="sidebar-divider"></div>
                <div class="section-header" @onclick="TogglePersistedSessions" style="cursor: pointer;">
                    <span class="section-header-label"><svg style="vertical-align:middle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Saved Sessions (@filteredPersistedSessions.Count())</span>
                    <span class="toggle-icon">@(showPersistedSessions ? "▼" : "▶")</span>
                </div>
                
                @if (showPersistedSessions)
                {
                    <div class="filter-box">
                        <input type="text" @bind="sessionFilter" @bind:event="oninput" 
                               placeholder="Filter sessions..." class="filter-input" />
                    </div>
                    
                    @foreach (var persisted in filteredPersistedSessions.Take(30))
                    {
                        <div class="session-item persisted" 
                             @onclick="() => ResumeSession(persisted)"
                             title="@GetTooltip(persisted)">
                            <div class="session-info">
                                <span class="session-name persisted-name">@(persisted.Title ?? "Untitled")</span>
                                <span class="session-meta-time">@persisted.LastModified.ToString("MMM dd h:mm tt")</span>
                                @if (!string.IsNullOrEmpty(persisted.WorkingDirectory))
                                {
                                    <span class="session-meta-dir">@GetShortPath(persisted.WorkingDirectory)</span>
                                }
                            </div>
                            <span class="resume-icon"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg> Resume</span>
                        </div>
                    }
                }
            }
        </div>
    };

    private string selectedModel = "claude-opus-4.6";
    private string sessionFilter = "";
    private bool isCreating = false;
    private string? createError = null;
    private bool showPersistedSessions = false;
    private bool showDirectoryInput = false;
    private string? renamingSession = null;
    private string currentPage = "/";
    private List<AgentSessionInfo> sessions = new();
    private List<PersistedSessionInfo> persistedSessions = new();

    private async Task ToggleFlyout()
    {
        await OnToggleFlyout.InvokeAsync();
    }

    private readonly string[] availableModels = new[]
    {
        "claude-opus-4.6",
        "claude-sonnet-4.5",
        "claude-sonnet-4",
        "claude-haiku-4.5",
        "gpt-5.2",
        "gpt-5.1",
        "gpt-5",
        "gpt-5-mini",
        "gemini-3-pro-preview",
    };

    private IEnumerable<PersistedSessionInfo> filteredPersistedSessions => 
        string.IsNullOrWhiteSpace(sessionFilter) 
            ? persistedSessions 
            : persistedSessions.Where(s => 
                (s.Title?.Contains(sessionFilter, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.Preview?.Contains(sessionFilter, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.WorkingDirectory?.Contains(sessionFilter, StringComparison.OrdinalIgnoreCase) ?? false) ||
                s.SessionId.Contains(sessionFilter, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        currentPage = new Uri(Nav.Uri).AbsolutePath;
        Nav.LocationChanged += (_, e) => { currentPage = new Uri(e.Location).AbsolutePath; InvokeAsync(StateHasChanged); };
        CopilotService.OnStateChanged += RefreshSessions;
        CopilotService.OnSessionComplete += HandleSessionComplete;
        RefreshSessions();
        LoadPersistedSessions();
    }

    private HashSet<string> completedSessions = new();

    private void HandleSessionComplete(string sessionName, string summary)
    {
        completedSessions.Add(sessionName);
        InvokeAsync(StateHasChanged);
        // Auto-clear highlight after 10 seconds
        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            completedSessions.Remove(sessionName);
            InvokeAsync(StateHasChanged);
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up Enter key handler via JS to avoid Blazor round-trips on every keystroke
            await JS.InvokeVoidAsync("eval", @"
                document.getElementById('sessionNameInput')?.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.querySelector('.new-session button')?.click();
                    }
                });
            ");
        }
    }

    private void RefreshSessions()
    {
        sessions = CopilotService.GetAllSessions().ToList();
        if (showPersistedSessions)
        {
            LoadPersistedSessions();
        }
        InvokeAsync(StateHasChanged);
    }

    private void LoadPersistedSessions()
    {
        persistedSessions = CopilotService.GetPersistedSessions().ToList();
    }

    private void TogglePersistedSessions()
    {
        showPersistedSessions = !showPersistedSessions;
        if (showPersistedSessions)
        {
            LoadPersistedSessions();
        }
    }

    private async Task CreateSession()
    {
        // Try both desktop and flyout input IDs
        var name = await JS.InvokeAsync<string>("eval", 
            "document.getElementById('sessionNameInput')?.value || document.getElementById('flyoutSessionNameInput')?.value || ''");
        if (string.IsNullOrWhiteSpace(name) || isCreating) return;

        // Read working directory if the input is visible
        string? workingDir = null;
        if (showDirectoryInput)
        {
            var dirValue = await JS.InvokeAsync<string>("eval", 
                "document.getElementById('sessionDirInput')?.value || document.getElementById('flyoutSessionDirInput')?.value || ''");
            if (!string.IsNullOrWhiteSpace(dirValue))
                workingDir = dirValue.Trim();
        }

        isCreating = true;
        createError = null;
        try
        {
            var sessionInfo = await CopilotService.CreateSessionAsync(name.Trim(), selectedModel, workingDir);
            CopilotService.SwitchSession(sessionInfo.Name);
            // Clear both input variants
            await JS.InvokeVoidAsync("eval", @"
                var el = document.getElementById('sessionNameInput'); if(el) el.value='';
                var el2 = document.getElementById('flyoutSessionNameInput'); if(el2) el2.value='';
            ");
            if (showDirectoryInput)
                await JS.InvokeVoidAsync("eval", @"
                    var el = document.getElementById('sessionDirInput'); if(el) el.value='';
                    var el2 = document.getElementById('flyoutSessionDirInput'); if(el2) el2.value='';
                ");
            showDirectoryInput = false;
            await OnSessionSelected.InvokeAsync();
        }
        catch (Exception ex)
        {
            createError = ex.Message;
            Console.WriteLine($"Error creating session: {ex}");
        }
        finally
        {
            isCreating = false;
        }
    }

    private void ToggleDirectoryInput()
    {
        showDirectoryInput = !showDirectoryInput;
    }

    private async Task BrowseDirectory()
    {
#if MACCATALYST
        try
        {
            var dir = await FolderPickerService.PickFolderAsync();
            if (!string.IsNullOrEmpty(dir))
                await JS.InvokeVoidAsync("eval", $"document.getElementById('sessionDirInput').value = '{dir.Replace("'", "\\'")}'");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Folder picker error: {ex.Message}");
        }
#endif
    }

    private async Task ResumeSession(PersistedSessionInfo persisted)
    {
        isCreating = true;
        try
        {
            // Use the session title as the display name
            var title = persisted.Title ?? "Untitled";
            // Truncate and make unique
            var displayName = title.Length > 30 ? title[..27] + "..." : title;
            var sessionInfo = await CopilotService.ResumeSessionAsync(persisted.SessionId, displayName);
            CopilotService.SwitchSession(sessionInfo.Name);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error resuming session: {ex.Message}");
        }
        finally
        {
            isCreating = false;
        }
    }

    private async Task StartRename(string sessionName)
    {
        renamingSession = sessionName;
        StateHasChanged();
        // Focus the input after render
        await Task.Yield();
        await JS.InvokeVoidAsync("eval", @"
            var el = document.getElementById('renameInput');
            if (el) { el.focus(); el.select(); }
        ");
    }

    private async Task CommitRename()
    {
        if (renamingSession == null) return;
        var oldName = renamingSession;
        renamingSession = null;

        var newName = await JS.InvokeAsync<string>("eval", "document.getElementById('renameInput')?.value || ''");
        if (!string.IsNullOrWhiteSpace(newName) && newName.Trim() != oldName)
        {
            CopilotService.RenameSession(oldName, newName.Trim());
        }
    }

    private async Task HandleRenameKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await CommitRename();
        }
        else if (e.Key == "Escape")
        {
            renamingSession = null;
        }
    }

    private async Task SelectSession(string name)
    {
        completedSessions.Remove(name);
        CopilotService.SwitchSession(name);
        CopilotService.SaveUiState("/", name);
        await OnSessionSelected.InvokeAsync();
    }

    private async Task CloseSession(string name)
    {
        await CopilotService.CloseSessionAsync(name);
    }

    private string GetTooltip(PersistedSessionInfo persisted)
    {
        var tooltip = $"Session: {persisted.SessionId}\n";
        if (!string.IsNullOrEmpty(persisted.WorkingDirectory))
            tooltip += $"Directory: {persisted.WorkingDirectory}\n";
        if (!string.IsNullOrEmpty(persisted.Preview))
            tooltip += $"\nFirst message:\n{persisted.Preview}";
        return tooltip;
    }

    private string GetShortPath(string? path)
    {
        if (string.IsNullOrEmpty(path)) return "";
        var parts = path.Split('/');
        return parts.Length > 2 ? "~/" + parts[^1] : path;
    }

    public void Dispose()
    {
        CopilotService.OnStateChanged -= RefreshSessions;
        CopilotService.OnSessionComplete -= HandleSessionComplete;
    }
}
