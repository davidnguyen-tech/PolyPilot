@using AutoPilot.App.Models
@using Markdig

@* Shared chat message list — used by both Home.razor (full) and Dashboard.razor (compact) *@

<div class="chat-message-list @(Compact ? "compact" : "full")">
    @if (!Messages.Any() && string.IsNullOrEmpty(StreamingContent))
    {
        <p class="chat-empty">@(Compact ? "No messages yet" : "Start a conversation with Copilot!")</p>
    }
    else
    {
        @foreach (var msg in Messages)
        {
            @switch (msg.MessageType)
            {
                case ChatMessageType.User:
                    <div class="chat-msg user">
                        @if (!Compact)
                        {
                            <div class="chat-msg-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                        }
                        <div class="chat-msg-content">
                            @if (Compact)
                            {
                                <span class="chat-msg-role">You</span>
                            }
                            <div class="chat-msg-text">@((MarkupString)FormatUserMessage(msg.Content))</div>
                            @if (!Compact)
                            {
                                <div class="chat-msg-time">@msg.Timestamp.ToString("HH:mm")</div>
                            }
                        </div>
                    </div>
                    break;

                case ChatMessageType.Assistant:
                    <div class="chat-msg assistant">
                        @if (!Compact)
                        {
                            <div class="chat-msg-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="2" y="8" width="20" height="8" rx="2"/><path d="M6 16v4"/><path d="M18 16v4"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg></div>
                        }
                        <div class="chat-msg-content">
                            @if (Compact)
                            {
                                <span class="chat-msg-role">AI</span>
                            }
                            <div class="chat-msg-text markdown-body">@((MarkupString)RenderMarkdown(msg.Content))</div>
                            @if (!Compact)
                            {
                                <div class="chat-msg-time">@msg.Timestamp.ToString("HH:mm")</div>
                            }
                        </div>
                    </div>
                    break;

                case ChatMessageType.Reasoning:
                    @if (Compact)
                    {
                        <div class="chat-msg reasoning">
                            <span class="chat-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.4V20a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.6c2.9-1.1 5-4 5-7.4a8 8 0 0 0-8-8z"/><line x1="10" y1="22" x2="14" y2="22"/></svg></span>
                            <span class="chat-msg-text">@(msg.IsComplete ? "Thought" : "Thinking...")</span>
                        </div>
                    }
                    else
                    {
                        <div class="reasoning-block @(msg.IsCollapsed && LineCount(msg.Content) > 5 ? "collapsed" : "")">
                            <button class="reasoning-header" @onclick="() => msg.IsCollapsed = !msg.IsCollapsed">
                                <span class="reasoning-title"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.4V20a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.6c2.9-1.1 5-4 5-7.4a8 8 0 0 0-8-8z"/><line x1="10" y1="22" x2="14" y2="22"/></svg> @(msg.IsComplete ? "Thought" : "Thinking...")</span>
                                @if (LineCount(msg.Content) > 5)
                                {
                                    <span class="collapse-icon">@(msg.IsCollapsed ? "▶" : "▼")</span>
                                }
                            </button>
                            @if (!msg.IsCollapsed || LineCount(msg.Content) <= 5)
                            {
                                <div class="reasoning-content">@msg.Content</div>
                            }
                            else
                            {
                                <div class="reasoning-content preview">@FirstLines(msg.Content, 3)</div>
                            }
                        </div>
                    }
                    break;

                case ChatMessageType.ToolCall:
                    @if (Compact)
                    {
                        <div class="chat-msg tool">
                            <span class="chat-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>
                            <span class="chat-msg-text">@FormatToolName(msg.ToolName ?? "tool") @(msg.IsComplete ? (msg.IsSuccess ? "✓" : "✗") : "…")</span>
                        </div>
                    }
                    else if (msg.ToolName == "task_complete")
                    {
                        <div class="task-complete-card">
                            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            <span class="task-complete-text">@(string.IsNullOrEmpty(msg.Content) || IsUnusableResult(msg.Content) ? "Task complete" : msg.Content)</span>
                        </div>
                    }
                    else
                    {
                        <div class="tool-card @(msg.IsComplete ? (msg.IsSuccess ? "success" : "error") : "running")">
                            <div class="tool-header">
                                <span class="tool-info"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> @FormatToolName(msg.ToolName ?? "")</span>
                                <span class="tool-status">
                                    @if (!msg.IsComplete)
                                    {
                                        <svg class="icon spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.22-8.56"/></svg> <text>Running</text>
                                    }
                                    else if (msg.IsSuccess)
                                    {
                                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> <text>Done</text>
                                    }
                                    else
                                    {
                                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> <text>Failed</text>
                                    }
                                </span>
                            </div>
                            @if (msg.IsComplete && !string.IsNullOrEmpty(msg.Content) && !IsUnusableResult(msg.Content))
                            {
                                @if (GetImagePath(msg.Content) is string imgPath && FileToDataUri(imgPath) is string dataUri)
                                {
                                    <div class="tool-result-section tool-image-result">
                                        <img src="@dataUri" alt="@System.IO.Path.GetFileName(imgPath)" />
                                    </div>
                                }
                                else if (LineCount(msg.Content) <= 5)
                                {
                                    <div class="tool-result-section">
                                        <pre class="tool-result-content">@TruncateResult(msg.Content)</pre>
                                    </div>
                                }
                                else
                                {
                                    <div class="tool-result-section">
                                        <button class="tool-result-toggle" @onclick="() => msg.IsCollapsed = !msg.IsCollapsed">
                                            @(msg.IsCollapsed ? "Show Full Result ▶" : "Collapse ▼")
                                        </button>
                                        @if (!msg.IsCollapsed)
                                        {
                                            <pre class="tool-result-content">@TruncateResult(msg.Content)</pre>
                                        }
                                        else
                                        {
                                            <pre class="tool-result-content preview">@FirstLines(msg.Content, 3)</pre>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }
                    break;

                case ChatMessageType.Error:
                    <div class="@(Compact ? "chat-msg error" : "error-card")">
                        @if (Compact)
                        {
                            <span class="chat-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
                            <span class="chat-msg-text">@msg.Content</span>
                        }
                        else
                        {
                            <span class="error-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
                            <span class="error-text">@msg.Content</span>
                        }
                    </div>
                    break;

                case ChatMessageType.System:
                    <div class="chat-msg system">
                        <div class="system-text">@msg.Content</div>
                    </div>
                    break;
            }
        }

        @* Current tool activity *@
        @if (!string.IsNullOrEmpty(CurrentToolName))
        {
            @if (Compact)
            {
                <div class="chat-msg tool">
                    <span class="chat-msg-role"><svg style="vertical-align:middle" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>
                    <span class="chat-msg-text">@FormatToolName(CurrentToolName) …</span>
                </div>
            }
            else
            {
                <div class="tool-card running">
                    <div class="tool-header">
                        <span class="tool-info"><svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> @FormatToolName(CurrentToolName)</span>
                        <span class="tool-status"><svg class="icon spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.22-8.56"/></svg> @ToolCount tool@(ToolCount != 1 ? "s" : "")</span>
                    </div>
                </div>
            }
        }

        @* Streaming content *@
        @if (!string.IsNullOrEmpty(StreamingContent))
        {
            <div class="chat-msg assistant streaming">
                @if (!Compact)
                {
                    <div class="chat-msg-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="2" y="8" width="20" height="8" rx="2"/><path d="M6 16v4"/><path d="M18 16v4"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg></div>
                }
                <div class="chat-msg-content">
                    @if (Compact)
                    {
                        <span class="chat-msg-role">AI</span>
                    }
                    <div class="chat-msg-text markdown-body">@((MarkupString)RenderMarkdown(StreamingContent))</div>
                </div>
            </div>
        }

        @* Activity indicator *@
        @if (IsProcessing && string.IsNullOrEmpty(StreamingContent) && string.IsNullOrEmpty(CurrentToolName))
        {
            <div class="chat-msg assistant">
                @if (Compact)
                {
                    <span class="chat-msg-role">AI</span>
                    <span class="chat-msg-text thinking">@(string.IsNullOrEmpty(ActivityText) ? "Thinking..." : ActivityText)</span>
                }
                else
                {
                    <div class="chat-msg-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="2" y="8" width="20" height="8" rx="2"/><path d="M6 16v4"/><path d="M18 16v4"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg></div>
                    <div class="chat-msg-content">
                        <div class="chat-msg-text thinking">@(string.IsNullOrEmpty(ActivityText) ? "Thinking..." : ActivityText)</div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public List<ChatMessage> Messages { get; set; } = new();
    [Parameter] public string StreamingContent { get; set; } = "";
    [Parameter] public string CurrentToolName { get; set; } = "";
    [Parameter] public int ToolCount { get; set; }
    [Parameter] public string ActivityText { get; set; } = "";
    [Parameter] public bool IsProcessing { get; set; }
    [Parameter] public bool Compact { get; set; }

    private static readonly MarkdownPipeline MdPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions().Build();

    private static readonly Dictionary<string, string> _imageCache = new();
    private static readonly Dictionary<int, string> _markdownCache = new();

    private static readonly System.Text.RegularExpressions.Regex ImagePathRegex = new(
        @"(?<!\(|""|\w)((?:/[\w\-. ]+)+\.(?:png|jpg|jpeg|gif|webp|svg|bmp|tiff))(?!\)|""|\w)",
        System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.Compiled);

    internal static string RenderMarkdown(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var key = content.GetHashCode();
        if (_markdownCache.TryGetValue(key, out var cached)) return cached;
        try
        {
            var html = Markdig.Markdown.ToHtml(content, MdPipeline);
            html = ImagePathRegex.Replace(html, match =>
            {
                var path = match.Value;
                var dataUri = FileToDataUri(path);
                if (dataUri != null)
                    return $"<img src=\"{dataUri}\" alt=\"{System.IO.Path.GetFileName(path)}\" />";
                return match.Value;
            });
            if (_markdownCache.Count < 500) _markdownCache[key] = html;
            return html;
        }
        catch { return System.Net.WebUtility.HtmlEncode(content).Replace("\n", "<br/>"); }
    }

    internal static string FormatUserMessage(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var lines = content.Split('\n');
        var sb = new System.Text.StringBuilder();
        foreach (var line in lines)
        {
            var trimmed = line.Trim();
            if (trimmed.StartsWith('/') && ImageExtensions.Any(ext => 
                trimmed.EndsWith(ext, StringComparison.OrdinalIgnoreCase)) &&
                System.IO.File.Exists(trimmed))
            {
                var dataUri = FileToDataUri(trimmed);
                if (dataUri != null)
                {
                    sb.Append($"<div class=\"user-image-attachment\"><img src=\"{dataUri}\" alt=\"{System.Net.WebUtility.HtmlEncode(System.IO.Path.GetFileName(trimmed))}\" /><span class=\"user-image-name\">{System.Net.WebUtility.HtmlEncode(System.IO.Path.GetFileName(trimmed))}</span></div>");
                    continue;
                }
            }
            if (sb.Length > 0) sb.Append("<br/>");
            sb.Append(System.Net.WebUtility.HtmlEncode(line));
        }
        return sb.ToString();
    }

    internal static int LineCount(string? text)
    {
        if (string.IsNullOrEmpty(text)) return 0;
        var count = 1;
        foreach (var c in text) { if (c == '\n') count++; }
        return count;
    }

    internal static string FirstLines(string? text, int lines)
    {
        if (string.IsNullOrEmpty(text)) return "";
        var idx = 0;
        for (var i = 0; i < lines && idx < text.Length; i++)
        {
            var next = text.IndexOf('\n', idx);
            if (next < 0) break;
            idx = next + 1;
        }
        if (idx <= 0 || idx >= text.Length) return text;
        return text[..idx] + "…";
    }

    internal static string FormatToolName(string toolName)
    {
        if (string.IsNullOrEmpty(toolName)) return "";
        return string.Join(" ", toolName.Split('_').Select(w =>
            w.Length > 0 ? char.ToUpperInvariant(w[0]) + w[1..].ToLowerInvariant() : w));
    }

    internal static string TruncateResult(string result, int maxLength = 1500)
    {
        if (string.IsNullOrEmpty(result) || result.Length <= maxLength) return result ?? "";
        return result[..maxLength] + "\n… (truncated)";
    }

    internal static bool IsUnusableResult(string? content)
    {
        if (string.IsNullOrEmpty(content)) return true;
        if (content.StartsWith("GitHub.Copilot.SDK.")) return true;
        if (content is "(no result)" or "Intent logged") return true;
        return false;
    }

    private static readonly string[] ImageExtensions = { ".png", ".jpg", ".jpeg", ".gif", ".webp", ".svg", ".bmp", ".tiff" };

    internal static string? GetImagePath(string? content)
    {
        if (string.IsNullOrWhiteSpace(content)) return null;
        var trimmed = content.Trim();
        foreach (var ext in ImageExtensions)
        {
            var idx = trimmed.LastIndexOf(ext, StringComparison.OrdinalIgnoreCase);
            if (idx < 0) continue;
            var endIdx = idx + ext.Length;
            var pathStart = trimmed.LastIndexOf(' ', idx) + 1;
            if (pathStart < 0) pathStart = 0;
            var path = trimmed[pathStart..endIdx];
            if (path.StartsWith('/') && System.IO.File.Exists(path))
                return path;
        }
        return null;
    }

    internal static string? FileToDataUri(string path)
    {
        if (_imageCache.TryGetValue(path, out var cached)) return cached;
        try
        {
            if (!System.IO.File.Exists(path)) return null;
            var bytes = System.IO.File.ReadAllBytes(path);
            var ext = System.IO.Path.GetExtension(path).ToLowerInvariant();
            var mime = ext switch
            {
                ".png" => "image/png",
                ".jpg" or ".jpeg" => "image/jpeg",
                ".gif" => "image/gif",
                ".webp" => "image/webp",
                ".svg" => "image/svg+xml",
                ".bmp" => "image/bmp",
                ".tiff" or ".tif" => "image/tiff",
                _ => "application/octet-stream"
            };
            var dataUri = $"data:{mime};base64,{Convert.ToBase64String(bytes)}";
            _imageCache[path] = dataUri;
            return dataUri;
        }
        catch { return null; }
    }
}
