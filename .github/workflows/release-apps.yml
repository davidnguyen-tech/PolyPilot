name: Release to TestFlight & Google Play

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override app version (leave empty to use APP_VERSION repo variable)'
        required: false
      build_number_offset:
        description: 'Offset added to run number (increase if you need to jump ahead, default: repo var BUILD_NUMBER_OFFSET or 0)'
        required: false
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  MAUI_PROJECT_PATH: 'PolyPilot/PolyPilot.csproj'
  APP_VERSION: ${{ inputs.version_override || vars.APP_VERSION || '1.0.0' }}

jobs:
  # ─────────────────────────────────────────────
  # Check if there are new commits (skips on schedule if nothing changed)
  # ─────────────────────────────────────────────
  check-changes:
    name: Check for new commits
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for commits in last 24 hours
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger — always release"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          COUNT=$(git log --oneline --since="24 hours ago" | wc -l | tr -d ' ')
          echo "Commits in last 24 hours: $COUNT"

          if [ "$COUNT" -gt 0 ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            git log --oneline --since="24 hours ago"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No new commits — skipping release"
          fi

  # ─────────────────────────────────────────────
  # Android → Google Play (Open Testing)
  # ─────────────────────────────────────────────
  build-android:
    name: Build Android AAB
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_release == 'true'

    steps:
      - name: Compute build number
        id: build
        run: |
          OFFSET=${{ inputs.build_number_offset || vars.BUILD_NUMBER_OFFSET || '0' }}
          BUILD=$(( ${{ github.run_number }} + OFFSET ))
          echo "number=$BUILD" >> $GITHUB_OUTPUT
          echo "Build number: ${{ github.run_number }} + $OFFSET = $BUILD"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Install MAUI workload
        run: dotnet workload install maui-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Decode Android keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ${{ github.workspace }}/keystore.jks

      - name: Publish Android AAB
        run: |
          dotnet publish ${{ env.MAUI_PROJECT_PATH }} \
            -f net10.0-android \
            -c Release \
            -p:ApplicationId=nl.versluis.polypilot \
            -p:AndroidPackageFormat=aab \
            -p:AndroidKeyStore=true \
            -p:AndroidSigningKeyStore='${{ github.workspace }}/keystore.jks' \
            -p:AndroidSigningKeyAlias='${{ secrets.ANDROID_KEY_ALIAS }}' \
            -p:AndroidSigningKeyPass='${{ secrets.ANDROID_KEY_PASSWORD }}' \
            -p:AndroidSigningStorePass='${{ secrets.ANDROID_KEYSTORE_PASSWORD }}' \
            -p:ApplicationDisplayVersion='${{ env.APP_VERSION }}' \
            -p:ApplicationVersion='${{ steps.build.outputs.number }}'

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: PolyPilot/bin/Release/net10.0-android/publish/*-Signed.aab
          retention-days: 30

  deploy-android:
    name: Deploy to Google Play
    runs-on: ubuntu-latest
    needs: build-android
    environment: android-release

    steps:
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./android-artifacts/

      - name: Upload to Google Play (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: 'nl.versluis.polypilot'
          releaseFiles: ./android-artifacts/*-Signed.aab
          track: beta
          status: completed

  # ─────────────────────────────────────────────
  # iOS → TestFlight
  # ─────────────────────────────────────────────
  build-ios:
    name: Build iOS IPA
    runs-on: macos-26
    needs: check-changes
    if: needs.check-changes.outputs.should_release == 'true'

    steps:
      - name: Compute build number
        id: build
        run: |
          OFFSET=${{ inputs.build_number_offset || vars.BUILD_NUMBER_OFFSET || '0' }}
          BUILD=$(( ${{ github.run_number }} + OFFSET ))
          echo "number=$BUILD" >> $GITHUB_OUTPUT
          echo "Build number: ${{ github.run_number }} + $OFFSET = $BUILD"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Install MAUI workload
        run: |
          dotnet workload update
          dotnet workload install maui

      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

      - name: Install provisioning profile
        run: |
          PP_PATH="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PP_PATH"
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 -d > "$PP_PATH/profile.mobileprovision"

      - name: Publish iOS IPA
        run: |
          dotnet publish ${{ env.MAUI_PROJECT_PATH }} \
            -f net10.0-ios \
            -c Release \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:ApplicationId=nl.versluis.polypilot \
            -p:CodesignKey="${{ secrets.IOS_CODESIGN_KEY }}" \
            -p:CodesignProvision="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            -p:ArchiveOnBuild=true \
            -p:ApplicationDisplayVersion='${{ env.APP_VERSION }}' \
            -p:ApplicationVersion='${{ steps.build.outputs.number }}'

      - name: Find IPA file
        id: find_ipa
        run: |
          IPA_PATH=$(find PolyPilot/bin/Release/net10.0-ios -name "*.ipa" | head -1)
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "Found IPA at: $IPA_PATH"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.find_ipa.outputs.IPA_PATH }}
          retention-days: 30

  deploy-ios:
    name: Deploy to TestFlight
    runs-on: macos-26
    needs: build-ios
    environment: ios-release

    steps:
      - name: Compute build number
        id: build
        run: |
          OFFSET=${{ inputs.build_number_offset || vars.BUILD_NUMBER_OFFSET || '0' }}
          BUILD=$(( ${{ github.run_number }} + OFFSET ))
          echo "number=$BUILD" >> $GITHUB_OUTPUT

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./ios-artifacts/

      - name: Find IPA file
        id: find_ipa
        run: |
          IPA_PATH=$(find ./ios-artifacts -name "*.ipa" | head -1)
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "Found IPA at: $IPA_PATH"

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: ${{ steps.find_ipa.outputs.IPA_PATH }}
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

      - name: Distribute to external testers (MAUI Team)
        continue-on-error: true
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
          APP_BUNDLE_ID: 'nl.versluis.polypilot'
          BUILD_NUMBER: ${{ steps.build.outputs.number }}
          APP_VERSION: ${{ env.APP_VERSION }}
          BETA_GROUP_NAME: 'MAUI Team'
        run: |
          set -euo pipefail

          # Install fastlane
          gem install fastlane --no-document

          # Write API key JSON for fastlane
          mkdir -p private_keys
          echo "$APPSTORE_PRIVATE_KEY" > "private_keys/AuthKey_${APPSTORE_KEY_ID}.p8"
          cat > api_key.json <<APIEOF
          {
            "key_id": "${APPSTORE_KEY_ID}",
            "issuer_id": "${APPSTORE_ISSUER_ID}",
            "key_filepath": "private_keys/AuthKey_${APPSTORE_KEY_ID}.p8"
          }
          APIEOF

          echo "Waiting for build processing before distributing..."
          fastlane pilot distribute \
            --api_key_path api_key.json \
            --app_identifier "$APP_BUNDLE_ID" \
            --build_number "$BUILD_NUMBER" \
            --app_version "$APP_VERSION" \
            --groups "$BETA_GROUP_NAME" \
            --distribute_only

          rm -rf private_keys api_key.json
